import{s as r}from"./supabaseClient-Du47UBJl.js";/* empty css              */document.addEventListener("DOMContentLoaded",async()=>{const u=document.getElementById("behaviorForm"),l=document.getElementById("description"),m=document.getElementById("location"),p=document.getElementById("fileDetail"),A=document.getElementById("declaration"),F=document.getElementById("involvedStudents"),f=document.getElementById("misconduct"),g=document.getElementById("previousAttempts"),y=document.getElementById("descCounter"),v=document.getElementById("locationCounter"),h=document.getElementById("fileCounter"),E=document.getElementById("attemptCounter");function $(t){return t.trim().split(/\s+/).filter(Boolean).length}function i(t,e,n){t.addEventListener("input",()=>{let o=$(t.value);o>n&&(t.value=t.value.split(/\s+/).slice(0,n).join(" "),o=n),e.textContent=`${o} / ${n} words`})}i(l,y,500),i(m,v,100),i(p,h,100),i(g,E,100);let a=null;try{a=(await r.auth.getSession()).data.session}catch(t){console.error("Supabase session error:",t)}if(!a||!a.user){window.location.href="/login.html";return}const q=a.user.id;u.addEventListener("submit",async t=>{t.preventDefault();let e=[];const n=document.getElementById("complaintTitle").value.trim();if(n?/^[A-Za-z0-9\s]+$/.test(n)||e.push("Complaint title can only contain letters, numbers, and spaces."):e.push("Complaint title is required."),f.value||e.push("Please select the Nature of Misconduct."),l.value.trim()||e.push("Description is required."),A.checked||e.push("You must declare that the information is accurate."),e.length>0){alert(e.join(`
`));return}try{const{data:o,error:w}=await r.from("admin").select("id").eq("adminrole","Student Disciplinary Admin").single();if(w||!o){console.error("Error fetching Student Disciplinary Admin:",w),alert("System Error: Could not find Student Disciplinary Admin. Please contact support.");return}const L=o.id,{data:I,error:C}=await r.from("category").select("categoryid").eq("categoryname","Student Disciplinary").single();if(C||!I){console.error("Error fetching Student Disciplinary category:",C),alert("System Error: Could not find Student Disciplinary category. Please contact support.");return}const U=I.categoryid,{data:O,error:D}=await r.from("complaint").insert([{complainantid:q,adminid:L,categoryid:U,submitteddate:new Date().toISOString(),dateofincident:new Date().toISOString(),complainttitle:n,complaintdescription:l.value.trim(),complaintstatus:"Pending"}]).select().single();if(D){console.error("Complaint insert error:",D),alert("Failed to submit complaint. Please try again.");return}const S=O.complaintid,{error:b}=await r.from("studentbehaviorcomplaint").insert([{complaintid:S,accusedname:F.value.trim()||null,typeofbehavior:f.value,locationofincident:m.value.trim(),witnessdetail:document.getElementById("witness").value.trim()||null,previousattempts:g.value.trim()||null}]);if(b){console.error("Student behavior insert error:",b),alert("Failed to save student behavior complaint. Please try again.");return}const s=document.getElementById("fileUpload"),j=p.value.trim();if(s.files.length>0)for(let c=0;c<s.files.length;c++){const d=s.files[c],x=`${Date.now()}_${d.name}`,{data:M,error:B}=await r.storage.from("user-uploads").upload(x,d);if(B){console.error("File upload error:",B),alert("File upload failed. Please try again.");return}const{data:N}=r.storage.from("user-uploads").getPublicUrl(M.path),T=N.publicUrl,{error:P}=await r.from("complaintattachment").insert([{complaintid:S,fileurl:T,description:j,filename:d.name}]);if(P){console.error("Attachment insert error:",P),alert("Failed to save file info. Please try again.");return}}u.reset(),y.textContent="0 / 500 words",v.textContent="0 / 100 words",h.textContent="0 / 100 words",E.textContent="0 / 100 words",alert("Student behavior complaint submitted successfully!")}catch(o){console.error(o),alert("Something went wrong. Please try again.")}})});
