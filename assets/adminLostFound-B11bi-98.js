import{s as u}from"./darkMode-C5bWaft0.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:Z}}=await u.auth.getSession();if(!Z){window.location.href="Login.html";return}const{data:ue}=await u.from("admin").select("id, adminrole").eq("id",Z.user.id).single();if(!ue){window.location.href="Login.html";return}const h=document.getElementById("itemsTableBody"),$=document.getElementById("itemsCardsView"),me=document.getElementById("itemCardTemplate"),G=document.getElementById("statusFilter"),ge=document.getElementById("itemRowTemplate"),K=document.getElementById("emptyTableStateTemplate"),X=document.getElementById("emptyCardStateTemplate");document.getElementById("errorTableStateTemplate");let k=[],B=[],i=1;const A=10;let L="all",r={source:"all",categories:[],statuses:[],dateFrom:null,dateTo:null};he();const R=document.getElementById("tabAllRequests"),P=document.getElementById("tabLostItems"),U=document.getElementById("tabFoundItems"),C=document.getElementById("uploadFoundItemBtn");R.addEventListener("click",()=>D("all")),P.addEventListener("click",()=>D("lost")),U.addEventListener("click",()=>D("found"));function D(e){L=e,i=1,[R,P,U].forEach(a=>a.classList.remove("active")),e==="all"&&R.classList.add("active"),e==="lost"&&P.classList.add("active"),e==="found"&&U.classList.add("active"),r.source=e,document.querySelectorAll(".filter-source-btn").forEach(a=>{a.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),a.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")});const n=document.querySelector(`.filter-source-btn[data-source="${e}"]`);n&&(n.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),n.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300")),e==="all"||e==="found"?C.classList.remove("hidden"):C.classList.add("hidden"),E()}(L==="all"||L==="found")&&C.classList.remove("hidden");const H=document.getElementById("uploadFoundModal"),ee=document.getElementById("uploadFoundItemForm"),te=document.getElementById("foundItemImage"),j=document.getElementById("imagePreview"),fe=document.getElementById("previewImg");C.addEventListener("click",()=>{H.classList.remove("hidden")}),document.getElementById("cancelUploadFoundBtn").addEventListener("click",()=>{H.classList.add("hidden"),ee.reset(),j.classList.add("hidden")}),te.addEventListener("change",e=>{const n=e.target.files[0];if(n){const a=new FileReader;a.onload=o=>{fe.src=o.target.result,j.classList.remove("hidden")},a.readAsDataURL(n)}}),document.getElementById("confirmUploadFoundBtn").addEventListener("click",async()=>{await ke()});const T=document.getElementById("filterModal"),M=document.getElementById("filterDrawer"),ye=document.getElementById("openFiltersBtn"),be=document.getElementById("closeFiltersBtn"),pe=document.getElementById("applyFiltersBtn"),Le=document.getElementById("clearFiltersBtn"),O=document.getElementById("filterBadge"),Y=document.getElementById("searchInput"),ae=document.getElementById("prevPage"),ne=document.getElementById("nextPage"),oe=document.getElementById("paginationNumbers");ye.addEventListener("click",()=>{T.classList.remove("hidden"),setTimeout(()=>{M.classList.remove("scale-95","opacity-0"),M.classList.add("scale-100","opacity-100")},10)}),be.addEventListener("click",z),T.addEventListener("click",e=>{e.target===T&&z()});function z(){M.classList.remove("scale-100","opacity-100"),M.classList.add("scale-95","opacity-0"),setTimeout(()=>{T.classList.add("hidden")},300)}document.querySelectorAll(".filter-source-btn").forEach(e=>{e.addEventListener("click",()=>{const n=e.dataset.source;document.querySelectorAll(".filter-source-btn").forEach(a=>{a.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),a.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),e.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),e.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),r.source=n})}),document.querySelector('.filter-source-btn[data-source="all"]').click(),document.querySelectorAll(".filter-category-chip").forEach(e=>{e.addEventListener("click",()=>{const n=e.dataset.category,a=r.categories.indexOf(n);a>-1?(r.categories.splice(a,1),e.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")):(r.categories.push(n),e.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),e.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"))}),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),document.querySelectorAll(".filter-status-chip").forEach(e=>{e.addEventListener("click",()=>{const n=e.dataset.status,a=r.statuses.indexOf(n);a>-1?(r.statuses.splice(a,1),e.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")):(r.statuses.push(n),e.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),e.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"))}),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),document.querySelectorAll(".date-preset-btn").forEach(e=>{e.addEventListener("click",()=>{const n=e.dataset.preset,a=new Date;let o,d;switch(n){case"today":o=d=a;break;case"last7days":d=a,o=new Date(a),o.setDate(a.getDate()-7);break;case"last30days":d=a,o=new Date(a),o.setDate(a.getDate()-30);break;case"thismonth":o=new Date(a.getFullYear(),a.getMonth(),1),d=a;break}const s=l=>{const g=l.getFullYear(),t=String(l.getMonth()+1).padStart(2,"0"),c=String(l.getDate()).padStart(2,"0");return`${g}-${t}-${c}`};document.getElementById("filterModalDateFrom").value=s(o),document.getElementById("filterModalDateTo").value=s(d),document.querySelectorAll(".date-preset-btn").forEach(l=>{l.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),l.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),e.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),e.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300")})}),pe.addEventListener("click",()=>{r.dateFrom=document.getElementById("filterModalDateFrom").value,r.dateTo=document.getElementById("filterModalDateTo").value,re(),D(r.source),z()}),Le.addEventListener("click",()=>{r={source:"all",categories:[],statuses:[],dateFrom:null,dateTo:null},document.querySelectorAll(".filter-category-chip, .filter-status-chip, .date-preset-btn").forEach(e=>{e.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),document.querySelector('.filter-source-btn[data-source="all"]').click(),document.getElementById("filterModalDateFrom").value="",document.getElementById("filterModalDateTo").value="",re(),i=1,E()});function re(){let e=0;r.source!=="all"&&e++,e+=r.categories.length,e+=r.statuses.length,(r.dateFrom||r.dateTo)&&e++,e>0?(O.textContent=e,O.classList.remove("hidden")):O.classList.add("hidden")}Y.addEventListener("input",()=>{i=1,E()}),ae.addEventListener("click",()=>{i>1&&(i--,E())}),ne.addEventListener("click",()=>{i++,E()});const V=new URLSearchParams(window.location.search).get("status");V&&Array.from(G.options).some(n=>n.value===V)&&(G.value=V),await W(),await q();async function W(){const{data:e,error:n}=await u.from("lost_and_found").select("*").neq("status","Deleted").order("reported_date",{ascending:!1});if(n){console.error(n),h.innerHTML="";const a=document.getElementById("errorTableStateTemplate");a?h.appendChild(a.content.cloneNode(!0)):h.innerHTML='<tr><td colspan="7" class="text-center py-6 text-red-500">Error loading items</td></tr>';return}k=e,B.length>0&&E()}async function q(){const{data:e,error:n}=await u.from("found_items").select("*").order("created_at",{ascending:!1});if(n){console.error("Error loading found items:",n);return}B=e||[],E()}function Ee(e=null){const n=document.getElementById("totalItemsCount"),a=n.parentElement.childNodes[0];let o=0;const d=r.categories.length>0||r.statuses.length>0||r.dateFrom||r.dateTo||Y.value.trim()!=="";e!==null?(o=e,d?a.textContent="Results Found: ":a.textContent="Total Items: "):(L==="all"?o=k.length+B.length:L==="lost"?o=k.length:L==="found"&&(o=B.length),a.textContent="Total Items: "),n.innerText=o}function E(){h.innerHTML="",$.innerHTML="";const e=Y.value.toLowerCase();let n=[];L==="all"?n=[...k.map(t=>({...t,itemSource:"lost"})),...B.map(t=>({...t,itemSource:"found"}))]:L==="lost"?n=k.map(t=>({...t,itemSource:"lost"})):L==="found"&&(n=B.map(t=>({...t,itemSource:"found"})));let a=n.filter(t=>{const c=r.categories.length===0||r.categories.includes(t.item_type),_=r.statuses.length===0||r.statuses.includes(t.status);let b=!0;if(r.dateFrom||r.dateTo){const I=new Date(t.itemSource==="lost"?t.reported_date:t.created_at);if(I.setHours(0,0,0,0),r.dateFrom){const m=new Date(r.dateFrom);m.setHours(0,0,0,0),I<m&&(b=!1)}if(r.dateTo&&b){const m=new Date(r.dateTo);m.setHours(0,0,0,0),I>m&&(b=!1)}}const S=t.itemSource==="lost"?t.location_lost||"":t.location_found||"",F=(t.item_name||"").toLowerCase().includes(e)||(t.item_type||"").toLowerCase().includes(e)||(t.description||"").toLowerCase().includes(e)||(t.distinguishing_features||"").toLowerCase().includes(e)||(t.brand||"").toLowerCase().includes(e)||(t.model||"").toLowerCase().includes(e)||(t.serial_number||"").toLowerCase().includes(e)||(t.primary_color||"").toLowerCase().includes(e)||(t.secondary_color||"").toLowerCase().includes(e)||S.toLowerCase().includes(e);return c&&_&&b&&F});const o=a.length,d=Math.ceil(o/A);Ee(o),i>d&&(i=d||1),i<1&&(i=1);const s=(i-1)*A,l=Math.min(s+A,o),g=a.slice(s,l);if(document.getElementById("startRange").textContent=o===0?0:s+1,document.getElementById("endRange").textContent=l,document.getElementById("totalEntries").textContent=o,xe(d),a.length===0){Ie();return}g.forEach(t=>{const c=t.itemSource==="found";t.date_lost&&new Date(t.date_lost).toLocaleDateString();const _=c?t.created_at?new Date(t.created_at).toLocaleDateString():"N/A":t.reported_date?new Date(t.reported_date).toLocaleDateString():"N/A",b=c?t.location_found||"Unknown":t.location_lost||"Unknown",S=t.brand?`Brand: ${t.brand}`:"",F=t.primary_color?`Color: ${t.primary_color}`:"",I=[S,F].filter(Boolean).join(", ")||"-";let m="bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-300";t.status,c?(t.status==="Unclaimed"&&(m="bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300"),t.status==="Claimed"&&(m="bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300")):(t.status==="Lost"&&(m="bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300"),t.status==="Claim"&&(m="bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300"),t.status==="Found"&&(m="bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"),t.status==="Deleted"&&(m="bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300"));const f=c?t.found_item_id:t.item_id,y=ge.content.cloneNode(!0);y.querySelector(".item-name").textContent=t.item_name;const N=y.querySelector(".item-source");c?(N.textContent="Found Item",N.className="item-source px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"):(N.textContent="Lost Item",N.className="item-source px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300"),y.querySelector(".item-type").textContent=t.item_type,y.querySelector(".item-location").textContent=b,y.querySelector(".item-date").textContent=_,y.querySelector(".item-attributes").textContent=I;const ie=y.querySelector(".item-status");ie.textContent=t.status,ie.className=`item-status px-3 py-1 rounded-full text-xs font-bold ${m}`,y.querySelector(".btn-edit").onclick=()=>window.openStatusModal(f,t.status,t.itemSource),y.querySelector(".btn-preview").href=c?`AdminFoundItemDetails.html?id=${f}`:`AdminLostFoundDetails.html?id=${f}`,y.querySelector(".btn-delete").onclick=()=>window.openDeleteModal(f,t.itemSource),h.appendChild(y);const p=me.content.cloneNode(!0);p.querySelector(".card-type").textContent=t.item_type,p.querySelector(".card-title").textContent=t.item_name,p.querySelector(".card-location span").textContent=b,p.querySelector(".card-date").textContent=_;const ce=p.querySelector(".card-status");ce.textContent=t.status,ce.className=`card-status px-2 py-0.5 rounded text-[10px] font-bold uppercase ${m}`,p.querySelector(".card-attr").textContent=I,p.querySelector(".btn-edit").onclick=()=>window.openStatusModal(f,t.status,t.itemSource),p.querySelector(".Link-preview").href=c?`AdminFoundItemDetails.html?id=${f}`:`AdminLostFoundDetails.html?id=${f}`,p.querySelector(".btn-delete").onclick=()=>window.openDeleteModal(f,t.itemSource),$.appendChild(p)})}function Ie(){if(K){const e=K.content.cloneNode(!0);h.appendChild(e)}if(X){const e=X.content.cloneNode(!0);$.appendChild(e)}}function xe(e){oe.innerHTML="",ae.disabled=i===1,ne.disabled=i===e||e===0;let n=[];e<=7?n=Array.from({length:e},(a,o)=>o+1):i<=4?n=[1,2,3,4,5,"...",e]:i>=e-3?n=[1,"...",e-4,e-3,e-2,e-1,e]:n=[1,"...",i-1,i,i+1,"...",e],n.forEach(a=>{const o=document.createElement("button");o.className=`px-3 py-1 border rounded ${a===i?"bg-blue-600 text-white border-blue-600":"hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-white"}`,a==="..."?(o.textContent="...",o.disabled=!0,o.classList.add("cursor-default","border-none")):(o.textContent=a,o.onclick=()=>{i=a,E()}),oe.appendChild(o)})}const J=document.getElementById("statusModal"),Q=document.getElementById("deleteModal"),w=document.getElementById("modalStatusSelect"),de=document.getElementById("modalStatusReason"),se=document.getElementById("modalDeleteReason");let x=null,v=null;window.openStatusModal=(e,n,a)=>{x=e,v=a,w.innerHTML="",a==="found"?w.innerHTML=`
                <option value="Unclaimed">Unclaimed</option>
                <option value="Claimed">Claimed</option>
            `:w.innerHTML=`
                <option value="Lost">Lost</option>
                <option value="Claim">Claim (Match)</option>
                <option value="Found">Found (Returned)</option>
            `,w.value=n,de.value="",J.classList.remove("hidden")},window.openDeleteModal=(e,n)=>{x=e,v=n,se.value="",Q.classList.remove("hidden")},document.getElementById("cancelStatusBtn").addEventListener("click",()=>J.classList.add("hidden")),document.getElementById("cancelDeleteBtn").addEventListener("click",()=>Q.classList.add("hidden")),document.getElementById("confirmStatusBtn").addEventListener("click",async()=>{const e=w.value,n=de.value.trim();if(!n){alert("Please provide a feedback message/reason.");return}try{const a=v==="found"?"found_items":"lost_and_found",o=v==="found"?"found_item_id":"item_id",{error:d}=await u.from(a).update({status:e,admin_feedback:n}).eq(o,x);if(d)throw d;const s=k.find(l=>l.item_id===x);s&&s.user_id&&(await u.from("notifications").insert([{userid:s.user_id,type:"LostItemUpdate",message:`Status updated to ${e}. ${n}`,is_read:!1,lost_item_id:x}]),le(s,e,n)),J.classList.add("hidden"),await W(),await q(),alert(`Status updated to ${e}`)}catch(a){console.error(a),alert("Failed to update status")}}),document.getElementById("confirmDeleteBtn").addEventListener("click",async()=>{const e=se.value.trim();if(!e){alert("Please provide a reason for deletion.");return}try{const n=v==="found"?"found_items":"lost_and_found",a=v==="found"?"found_item_id":"item_id",{error:o}=await u.from(n).update({status:"Deleted",admin_feedback:e}).eq(a,x);if(o)throw o;const d=k.find(s=>s.item_id===x);d&&d.user_id&&(await u.from("notifications").insert([{userid:d.user_id,type:"Deleted",message:`Your report was deleted. Reason: ${e}`,is_read:!1,lost_item_id:x}]),le(d,"Deleted",e)),Q.classList.add("hidden"),await W(),await q(),alert("Item marked as deleted.")}catch(n){console.error(n),alert("Failed to delete item")}});async function le(e,n,a){try{const{data:o,error:d}=await u.from("users").select("email, first_name").eq("id",e.user_id).single();if(d||!o||!o.email)return;const s={to_name:o.first_name||"Student",to_email:o.email,complaint_title:`Lost Item: ${e.item_name}`,new_status:n,message:a};await emailjs.send("service_q77wg09","template_sb3k70p",s,"08jWWt0PNjZJ4BcQw"),console.log("Email sent successfully")}catch(o){console.error("Failed to send email:",o)}}async function ke(){const e=te.files[0];if(!e){alert("Please upload an image. Image is required for found items.");return}const n=document.getElementById("foundItemName").value.trim(),a=document.getElementById("foundItemType").value,o=document.getElementById("foundLocationFound").value.trim(),d=document.getElementById("foundDateFound").value;if(!n||!a||!o||!d){alert("Please fill in all required fields (Item Name, Type, Location Found, Date Found).");return}if(e.size>5*1024*1024){alert("Image size must be less than 5MB.");return}let s=null;try{const{data:{session:l}}=await u.auth.getSession();if(!l){alert("Session expired. Please login again.");return}const g=e.name.split(".").pop(),c=`found_items/${`${Date.now()}_${Math.random().toString(36).substring(7)}.${g}`}`,{data:_,error:b}=await u.storage.from("lost_found_images").upload(c,e);if(b)throw new Error(`Image upload failed: ${b.message}`);const{data:{publicUrl:S}}=u.storage.from("lost_found_images").getPublicUrl(c),F={admin_id:l.user.id,item_name:n,item_type:a,brand:document.getElementById("foundBrand").value.trim()||null,model:document.getElementById("foundModel").value.trim()||null,primary_color:document.getElementById("foundPrimaryColor").value.trim()||null,secondary_color:document.getElementById("foundSecondaryColor").value.trim()||null,serial_number:document.getElementById("foundSerialNumber").value.trim()||null,distinguishing_features:document.getElementById("foundDistinguishingFeatures").value.trim()||null,description:document.getElementById("foundDescription").value.trim()||null,location_found:o,date_found:d,time_found:document.getElementById("foundTimeFound").value||null,status:"Unclaimed"},{data:I,error:m}=await u.from("found_items").insert([F]).select().single();if(m)throw await u.storage.from("lost_found_images").remove([c]),new Error(`Database insert failed: ${m.message}`);s=I.found_item_id;const{error:f}=await u.from("lost_found_attachments").insert([{found_item_id:I.found_item_id,file_url:S,file_type:"image"}]);if(f)throw await u.from("found_items").delete().eq("found_item_id",s),await u.storage.from("lost_found_images").remove([c]),new Error(`Attachment insert failed: ${f.message}`);alert("Found item uploaded successfully!"),H.classList.add("hidden"),ee.reset(),j.classList.add("hidden"),await q(),E()}catch(l){console.error("Error uploading found item:",l),alert(`Failed to upload found item: ${l.message}`)}}function he(){const e=document.getElementById("mobileMenuButton"),n=document.getElementById("mobileMenu"),a=document.getElementById("overlay");if(e&&n){const g=e.cloneNode(!0);e.parentNode.replaceChild(g,e),g.addEventListener("click",()=>{n.classList.toggle("-translate-x-full"),a&&a.classList.toggle("hidden")}),a&&a.addEventListener("click",()=>{n.classList.add("-translate-x-full"),a.classList.add("hidden")})}const o=document.getElementById("profileButton"),d=document.getElementById("profileMenu");if(o&&d){const g=o.cloneNode(!0);o.parentNode.replaceChild(g,o),g.addEventListener("click",t=>{t.stopPropagation(),d.classList.contains("hidden")?d.classList.remove("hidden"):d.classList.add("hidden")}),document.addEventListener("click",t=>{!g.contains(t.target)&&!d.contains(t.target)&&d.classList.add("hidden")})}const s=document.getElementById("headerLogoutBtn"),l=document.getElementById("logoutModal");if(s&&l){const g=s.cloneNode(!0);s.parentNode.replaceChild(g,s),g.addEventListener("click",()=>l.classList.remove("hidden"));const t=document.getElementById("cancelLogoutBtn"),c=document.getElementById("confirmLogoutBtn");t&&(t.onclick=()=>l.classList.add("hidden")),c&&(c.onclick=async()=>{await u.auth.signOut(),window.location.href="Login.html"})}}});
