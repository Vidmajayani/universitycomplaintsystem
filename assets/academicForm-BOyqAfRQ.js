import{s as r}from"./supabaseClient-DP-aSKaS.js";import"./darkMode-DIftV1Qz.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:l}}=await r.auth.getSession();if(!l||!l.user){window.location.href="Login.html";return}const E=document.getElementById("complaintForm");function o(t,e){const n=document.getElementById(t).nextElementSibling;n&&n.classList.contains("error-text")&&(n.textContent=e,n.style.color="var(--color-error, #ff4d4d)")}function c(t){return t.trim()===""?0:t.trim().split(/\s+/).length}function F(t,e,i){const n=document.getElementById(t);let s=n.value.trim();const m=c(s);document.getElementById(e).textContent=`${m} / ${i} words`,m>i&&(n.value=s.split(/\s+/).slice(0,i).join(" "))}["description","fileDesc","previousAttempt"].forEach(t=>{const e=t==="description"?"descCounter":t==="fileDesc"?"fileCounter":"attemptCounter";document.getElementById(t).addEventListener("input",()=>F(t,e,t==="description"?500:100))});let d=l;if(!d||!d.user){window.location.href="Login.html";return}const O=d.user.id;E.addEventListener("submit",async t=>{t.preventDefault(),document.querySelectorAll(".error-text").forEach(a=>a.textContent="");let e=!0;const i=document.getElementById("complaintTitle").value.trim();i||(e=!1,o("complaintTitle","Complaint title is required."));const n=document.getElementById("dateIncident").value,s=new Date(n);(!n||s>=new Date)&&(e=!1,o("dateIncident","Incident date must be before today."));const u=document.getElementById("phone").value.trim();u&&!/^[0-9]{10}$/.test(u)&&(e=!1,o("phone","Phone number must be exactly 10 digits."));const v=document.getElementById("currentLevel").value;v||(e=!1,o("currentLevel","Please select a level."));const I=document.getElementById("semester").value;I||(e=!1,o("semester","Please select a semester."));const f=document.getElementById("description").value.trim();(c(f)>500||!f)&&(e=!1,o("description","Description must be less than 500 words."));const $=document.getElementById("fileDesc").value.trim();c($)>100&&(e=!1,o("fileDesc","File description must be less than 100 words."));const h=document.getElementById("previousAttempt").value.trim();c(h)>100&&(e=!1,o("previousAttempt","Previous attempts must be less than 100 words."));const w=document.getElementById("desiredOutcome").value.trim();if(c(w)>100&&(e=!1,o("desiredOutcome","Desired outcome must be less than 100 words.")),document.getElementById("declaration").checked||(e=!1,document.getElementById("declaration").nextElementSibling.insertAdjacentHTML("afterend",'<p class="error-text" style="color:red;">You must agree to the declaration.</p>')),!!e)try{const{data:a,error:B}=await r.from("admin").select("id").eq("adminrole","Academic Admin").single();if(B||!a){console.error("Error fetching Academic Admin:",B),alert("System Error: Could not find Academic Admin. Please contact support.");return}const q=a.id,{data:b,error:D}=await r.from("category").select("categoryid").eq("categoryname","Academic").single();if(D||!b){console.error("Error fetching Academic category:",D),alert("System Error: Could not find Academic category. Please contact support.");return}const T=b.categoryid,{data:U,error:A}=await r.from("complaint").insert([{complainantid:O,adminid:q,categoryid:T,submitteddate:new Date().toISOString(),dateofincident:n,complainttitle:i,complaintdescription:f,complaintstatus:"Pending"}]).select().single();if(A){console.error(A);return}const C=U.complaintid,{error:L}=await r.from("academiccomplaint").insert([{complaintid:C,lecturername:document.getElementById("lecturer").value.trim(),batchcode:document.getElementById("batchCode").value.trim(),modulename:document.getElementById("moduleName").value.trim(),currentlevel:v,phone:u,semester:I,specificationofissue:document.getElementById("issueSpec").value.trim(),previousattempts:h,desiredoutcome:w}]);if(L){console.error(L);return}const p=document.getElementById("file"),j=document.getElementById("fileDesc").value.trim();if(p.files.length>0)for(let g=0;g<p.files.length;g++){const y=p.files[g],M=`${Date.now()}_${y.name}`,{data:N,error:P}=await r.storage.from("user-uploads").upload(M,y);if(P){console.error("File upload error:",P),alert("File upload failed. Please try again.");return}const{data:Y}=r.storage.from("user-uploads").getPublicUrl(N.path),S=Y.publicUrl;console.log("File public URL:",S);const{error:x}=await r.from("complaintattachment").insert([{complaintid:C,fileurl:S,description:j,filename:y.name}]);if(x){console.error("Attachment insert error:",x),alert("Failed to save file info. Please try again.");return}}E.reset(),alert("Your Academic complaint has been submitted successfully!")}catch(a){console.error(a)}})});
