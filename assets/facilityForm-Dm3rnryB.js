import{s as i}from"./supabaseClient-Du47UBJl.js";/* empty css              */function l(e){return e.trim().split(/\s+/).filter(Boolean).length}const V=5*1024*1024,o=document.getElementById("description"),C=document.getElementById("descCounter");o.addEventListener("input",()=>{let e=l(o.value);C.textContent=`${e} / 500 words`,e>500&&(o.value=o.value.split(/\s+/).slice(0,500).join(" "))});const n=document.getElementById("fileDesc"),F=document.getElementById("fileCounter");n.addEventListener("input",()=>{let e=l(n.value);F.textContent=`${e} / 100 words`,e>100&&(n.value=n.value.split(/\s+/).slice(0,100).join(" "))});const a=document.getElementById("previousAttempt"),D=document.getElementById("prevAttemptCounter");a.addEventListener("input",()=>{let e=l(a.value);D.textContent=`${e} / 100 words`,e>100&&(a.value=a.value.split(/\s+/).slice(0,100).join(" "))});document.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("facilityComplaintForm");let c=null;try{c=(await i.auth.getSession()).data.session}catch(d){console.error("Supabase session error:",d)}if(!c||!c.user){window.location.href="/login.html";return}const A=c.user.id;e.addEventListener("submit",async d=>{d.preventDefault();let t=[];const u=document.getElementById("complaintTitle").value.trim();u?/^[A-Za-z0-9\s]+$/.test(u)||t.push("Complaint title can only contain letters, numbers, and spaces."):t.push("Complaint title is required."),document.querySelectorAll(".border-red-500").forEach(r=>{r.classList.remove("border-red-500")}),["facilityType","facilityIssue","floor","dateObservation","description"].forEach(r=>{const s=document.getElementById(r);s.value.trim()||(s.classList.add("border-red-500"),t.push(`${r.replace(/([A-Z])/g," $1")} is required.`))});let L=new Date(document.getElementById("dateObservation").value),y=new Date;y.setHours(0,0,0,0),L>y&&(t.push("Date of observation cannot be in the future."),document.getElementById("dateObservation").classList.add("border-red-500")),l(o.value)>500&&(t.push("Description cannot exceed 500 words."),o.classList.add("border-red-500")),l(n.value)>100&&(t.push("File description cannot exceed 100 words."),n.classList.add("border-red-500")),l(a.value)>100&&(t.push("Previous attempt cannot exceed 100 words."),a.classList.add("border-red-500"));let g=document.getElementById("file").files[0];if(g&&g.size>V&&t.push("Attached file must be less than 5 MB."),document.getElementById("declaration").checked||t.push("You must confirm the declaration."),t.length>0){alert(`Please fix the following issues:

`+t.join(`
`));return}try{const{data:r,error:s}=await i.from("admin").select("id").eq("adminrole","Facility Admin").single();if(s||!r){console.error("Error fetching Facility Admin:",s),alert("System Error: Could not find Facility Admin. Please contact support.");return}const P=r.id,{data:v,error:E}=await i.from("category").select("categoryid").eq("categoryname","Facility").single();if(E||!v){console.error("Error fetching Facility category:",E),alert("System Error: Could not find Facility category. Please contact support.");return}const x=v.categoryid,S=document.getElementById("dateObservation").value,$=o.value.trim(),{data:q,error:h}=await i.from("complaint").insert([{complainantid:A,adminid:P,categoryid:x,submitteddate:new Date().toISOString(),dateofincident:S,complainttitle:u,complaintdescription:$,complaintstatus:"Pending"}]).select().single();if(h){console.error("Complaint insert error:",h),alert("Failed to submit complaint. Please try again.");return}const w=q.complaintid,{error:I}=await i.from("facilitycomplaint").insert([{complaintid:w,typeoffacility:document.getElementById("facilityType").value,typeoffacilityissue:document.getElementById("facilityIssue").value,facilityfloor:document.getElementById("floor").value,previousattempt:a.value.trim()}]);if(I){console.error("Facility complaint insert error:",I),alert("Failed to save facility complaint. Please try again.");return}const m=document.getElementById("file"),O=n.value.trim();if(m.files.length>0)for(let f=0;f<m.files.length;f++){const p=m.files[f],j=`${Date.now()}_${p.name}`,{data:T,error:b}=await i.storage.from("user-uploads").upload(j,p);if(b){console.error("File upload error:",b),alert("File upload failed. Please try again.");return}const{data:M}=i.storage.from("user-uploads").getPublicUrl(T.path),U=M.publicUrl,{error:B}=await i.from("complaintattachment").insert([{complaintid:w,fileurl:U,description:O,filename:p.name}]);if(B){console.error("Attachment insert error:",B),alert("Failed to save file info. Please try again.");return}}e.reset(),C.textContent="0 / 500 words",F.textContent="0 / 100 words",D.textContent="0 / 100 words",alert("Facility complaint submitted successfully!")}catch(r){console.error(r),alert("Something went wrong. Please try again.")}})});
