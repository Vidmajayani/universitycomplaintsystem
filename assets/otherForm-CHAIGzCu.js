import{s as n}from"./supabaseClient-Du47UBJl.js";/* empty css              */document.addEventListener("DOMContentLoaded",async()=>{const p=document.getElementById("otherComplaintForm"),a=document.getElementById("dateIncident"),l=document.getElementById("description"),f=document.getElementById("fileDesc"),g=document.getElementById("previousAttempt"),S=document.getElementById("declaration"),P=document.getElementById("desiredOutcome"),A=document.getElementById("category"),y=document.getElementById("descCounter"),h=document.getElementById("fileCounter"),E=document.getElementById("attemptCounter"),F=new Date().toISOString().split("T")[0];a.setAttribute("max",F);function $(e){return e.trim().split(/\s+/).filter(Boolean).length}function c(e,t,r){e.addEventListener("input",()=>{let o=$(e.value);o>r&&(e.value=e.value.split(/\s+/).slice(0,r).join(" "),o=r),t.textContent=`${o} / ${r} words`})}c(l,y,500),c(f,h,100),c(g,E,100);let i=null;try{i=(await n.auth.getSession()).data.session}catch(e){console.error("Supabase session error:",e)}if(!i||!i.user){window.location.href="/login.html";return}const q=i.user.id;p.addEventListener("submit",async e=>{e.preventDefault();let t=[];const r=document.getElementById("complaintTitle").value.trim();r?/^[A-Za-z0-9\s]+$/.test(r)||t.push("Complaint title can only contain letters, numbers, and spaces."):t.push("Complaint title is required.");const o=new Date().toISOString().split("T")[0];if(a.value?a.value>o&&t.push("Date of Incident cannot be in the future."):t.push("Please select the Date of Incident."),l.value.trim()||t.push("Description is required."),S.checked||t.push("You must declare that the information is accurate."),t.length>0){alert(t.join(`
`));return}try{const{data:s,error:I}=await n.from("admin").select("id").eq("adminrole","General Admin").single();if(I||!s){console.error("Error fetching General Admin:",I),alert("System Error: Could not find General Admin. Please contact support.");return}const L=s.id,{data:v,error:w}=await n.from("category").select("categoryid").eq("categoryname","Other").single();if(w||!v){console.error("Error fetching Other category:",w),alert("System Error: Could not find Other category. Please contact support.");return}const T=v.categoryid,{data:G,error:C}=await n.from("complaint").insert([{complainantid:q,adminid:L,categoryid:T,submitteddate:new Date().toISOString(),dateofincident:a.value,complainttitle:r,complaintdescription:l.value.trim(),complaintstatus:"Pending"}]).select().single();if(C){console.error("Complaint insert error:",C),alert("Failed to submit complaint. Please try again.");return}const D=G.complaintid,{error:B}=await n.from("othercomplaint").insert([{complaintid:D,previousattempts:g.value.trim()||null,suggestedcategory:A.value.trim()||null,desiredoutcome:P.value.trim()||null}]);if(B){console.error("Other complaint insert error:",B),alert("Failed to save other complaint. Please try again.");return}const d=document.getElementById("file"),U=f.value.trim();if(d.files.length>0)for(let u=0;u<d.files.length;u++){const m=d.files[u],j=`${Date.now()}_${m.name}`,{data:x,error:b}=await n.storage.from("user-uploads").upload(j,m);if(b){console.error("File upload error:",b),alert("File upload failed. Please try again.");return}const{data:k}=n.storage.from("user-uploads").getPublicUrl(x.path),z=k.publicUrl,{error:O}=await n.from("complaintattachment").insert([{complaintid:D,fileurl:z,description:U,filename:m.name}]);if(O){console.error("Attachment insert error:",O),alert("Failed to save file info. Please try again.");return}}p.reset(),y.textContent="0 / 500 words",h.textContent="0 / 100 words",E.textContent="0 / 100 words",alert("Other complaint submitted successfully!")}catch(s){console.error(s),alert("Something went wrong. Please try again.")}})});
