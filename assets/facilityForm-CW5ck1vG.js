import{s as r}from"./supabaseClient-DP-aSKaS.js";import"./darkMode-5ojGJQDO.js";function l(e){return e.trim().split(/\s+/).filter(Boolean).length}const Z=5*1024*1024,o=document.getElementById("description"),C=document.getElementById("descCounter");o.addEventListener("input",()=>{let e=l(o.value);C.textContent=`${e} / 500 words`,e>500&&(o.value=o.value.split(/\s+/).slice(0,500).join(" "))});const n=document.getElementById("fileDesc"),F=document.getElementById("fileCounter");n.addEventListener("input",()=>{let e=l(n.value);F.textContent=`${e} / 100 words`,e>100&&(n.value=n.value.split(/\s+/).slice(0,100).join(" "))});const a=document.getElementById("previousAttempt"),D=document.getElementById("prevAttemptCounter");a.addEventListener("input",()=>{let e=l(a.value);D.textContent=`${e} / 100 words`,e>100&&(a.value=a.value.split(/\s+/).slice(0,100).join(" "))});document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await r.auth.getSession();if(!e||!e.user){window.location.href="Login.html";return}const p=document.getElementById("facilityComplaintForm");let c=e;if(!c||!c.user){window.location.href="Login.html";return}const L=c.user.id;p.addEventListener("submit",async A=>{A.preventDefault();let t=[];const d=document.getElementById("complaintTitle").value.trim();d?/^[A-Za-z0-9\s]+$/.test(d)||t.push("Complaint title can only contain letters, numbers, and spaces."):t.push("Complaint title is required."),document.querySelectorAll(".border-red-500").forEach(i=>{i.classList.remove("border-red-500")}),["facilityType","facilityIssue","floor","dateObservation","description"].forEach(i=>{const s=document.getElementById(i);s.value.trim()||(s.classList.add("border-red-500"),t.push(`${i.replace(/([A-Z])/g," $1")} is required.`))});let P=new Date(document.getElementById("dateObservation").value),y=new Date;y.setHours(0,0,0,0),P>y&&(t.push("Date of observation cannot be in the future."),document.getElementById("dateObservation").classList.add("border-red-500")),l(o.value)>500&&(t.push("Description cannot exceed 500 words."),o.classList.add("border-red-500")),l(n.value)>100&&(t.push("File description cannot exceed 100 words."),n.classList.add("border-red-500")),l(a.value)>100&&(t.push("Previous attempt cannot exceed 100 words."),a.classList.add("border-red-500"));let g=document.getElementById("file").files[0];if(g&&g.size>Z&&t.push("Attached file must be less than 5 MB."),document.getElementById("declaration").checked||t.push("You must confirm the declaration."),t.length>0){alert(`Please fix the following issues:

`+t.join(`
`));return}try{const{data:i,error:s}=await r.from("admin").select("id").eq("adminrole","Facility Admin").single();if(s||!i){console.error("Error fetching Facility Admin:",s),alert("System Error: Could not find Facility Admin. Please contact support.");return}const x=i.id,{data:v,error:E}=await r.from("category").select("categoryid").eq("categoryname","Facility").single();if(E||!v){console.error("Error fetching Facility category:",E),alert("System Error: Could not find Facility category. Please contact support.");return}const S=v.categoryid,$=document.getElementById("dateObservation").value,q=o.value.trim(),{data:O,error:h}=await r.from("complaint").insert([{complainantid:L,adminid:x,categoryid:S,submitteddate:new Date().toISOString(),dateofincident:$,complainttitle:d,complaintdescription:q,complaintstatus:"Pending"}]).select().single();if(h){console.error("Complaint insert error:",h),alert("Failed to submit complaint. Please try again.");return}const w=O.complaintid,{error:I}=await r.from("facilitycomplaint").insert([{complaintid:w,typeoffacility:document.getElementById("facilityType").value,typeoffacilityissue:document.getElementById("facilityIssue").value,facilityfloor:document.getElementById("floor").value,previousattempt:a.value.trim()}]);if(I){console.error("Facility complaint insert error:",I),alert("Failed to save facility complaint. Please try again.");return}const u=document.getElementById("file"),j=n.value.trim();if(u.files.length>0)for(let m=0;m<u.files.length;m++){const f=u.files[m],T=`${Date.now()}_${f.name}`,{data:M,error:b}=await r.storage.from("user-uploads").upload(T,f);if(b){console.error("File upload error:",b),alert("File upload failed. Please try again.");return}const{data:U}=r.storage.from("user-uploads").getPublicUrl(M.path),V=U.publicUrl,{error:B}=await r.from("complaintattachment").insert([{complaintid:w,fileurl:V,description:j,filename:f.name}]);if(B){console.error("Attachment insert error:",B),alert("Failed to save file info. Please try again.");return}}p.reset(),C.textContent="0 / 500 words",F.textContent="0 / 100 words",D.textContent="0 / 100 words",alert("Facility complaint submitted successfully!")}catch(i){console.error(i),alert("Something went wrong. Please try again.")}})});
