import{s as p}from"./supabaseClient-Du47UBJl.js";/* empty css              */import"./darkMode-DMjetaZp.js";let k=null,S=null,d=[],f=[],D={},m=1;const B=5,E=document.getElementById("complaintsTableBody"),Y=document.getElementById("searchInput"),v=document.getElementById("filterStatus"),x=document.getElementById("filterCategory"),U=document.getElementById("totalComplaintsCount"),Z=document.getElementById("startRange"),tt=document.getElementById("endRange"),et=document.getElementById("totalEntries"),G=document.getElementById("prevPage"),W=document.getElementById("nextPage"),L=document.getElementById("paginationNumbers"),nt=document.getElementById("complaintRowTemplate");document.addEventListener("DOMContentLoaded",()=>{at(),yt()});async function at(){const{data:{session:t}}=await p.auth.getSession();if(!t){window.location.href="Login.html";return}const{data:e,error:n}=await p.from("admin").select("id, adminrole").eq("id",t.user.id).single();if(n||!e){alert("Access denied."),window.location.href="Login.html";return}k=e.id,S=e.adminrole,console.log(`Logged in as Admin: ${S} (${k})`),S==="Master Admin"&&x&&x.classList.remove("hidden"),await rt();const a=new URLSearchParams(window.location.search).get("status");a&&v&&(v.value=a),ot()}async function ot(){try{E.textContent="";const t=document.createElement("tr"),e=document.createElement("td");e.colSpan=7,e.className="py-6 text-center",e.textContent="Loading complaints...",t.appendChild(e),E.appendChild(t);let n=p.from("complaint").select("*");S!=="Master Admin"&&(n=n.eq("adminid",k));const{data:r,error:a}=await n.order("submitteddate",{ascending:!1});if(a)throw a;if(d=r||[],d=d.map(l=>({...l,categoryName:D[l.categoryid]||"Unknown Category"})),d.length>0){const l=[...new Set(d.map(i=>i.complainantid))],{data:s,error:o}=await p.from("users").select("id, first_name, last_name").in("id",l);if(!o&&s){const i={};s.forEach(g=>{i[g.id]=`${g.first_name} ${g.last_name}`}),d=d.map(g=>({...g,complainantName:i[g.complainantid]||"Unknown User"}))}}X(),y()}catch(t){console.error("Error loading complaints:",t),E.textContent="";const e=document.createElement("tr"),n=document.createElement("td");n.colSpan=7,n.className="py-6 text-center text-red-500",n.textContent="Error loading complaints. Please try again.",e.appendChild(n),E.appendChild(e)}}async function rt(){try{const{data:t,error:e}=await p.from("category").select("categoryid, categoryname");if(e)throw e;t&&(t.forEach(n=>{D[n.categoryid]=n.categoryname}),console.log("Categories loaded:",D))}catch(t){console.error("Error fetching categories:",t)}}function I(){const t=document.getElementById("complaintsTableBody"),e=document.getElementById("complaintsCardsView");if(t&&(t.textContent=""),e&&(e.textContent=""),f.length===0){if(t){const o=document.createElement("tr"),i=document.createElement("td");i.colSpan=7,i.className="py-8 text-center text-gray-500 dark:text-gray-400",i.innerHTML='<i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i><br>No complaints found.',o.appendChild(i),t.appendChild(o)}e&&(e.innerHTML=`
                <div class="col-span-full py-8 text-center text-gray-500 dark:text-gray-400">
                    <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i><br>No complaints found.
                </div>
            `);return}const n=(m-1)*B,r=Math.min(n+B,f.length),a=f.slice(n,r);Z.textContent=f.length>0?n+1:0,tt.textContent=r,et.textContent=f.length;const l=document.createDocumentFragment(),s=document.createDocumentFragment();a.forEach(o=>{const i=nt.content.cloneNode(!0);i.querySelector("tr"),i.querySelector(".col-title").textContent=o.complainttitle||"Untitled";const g=i.querySelector(".col-category"),b=o.categoryName||"General";g.textContent=b;const M=c=>c==="Academic"?"bg-purple-100 text-purple-600 dark:bg-purple-900 dark:text-purple-300":c==="Facility"?"bg-orange-100 text-orange-600 dark:bg-orange-900 dark:text-orange-300":c==="Technical"?"bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300":c==="Administrative"?"bg-pink-100 text-pink-600 dark:bg-pink-900 dark:text-pink-300":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300";g.className=`col-category inline-block px-3 py-1 rounded-full text-xs font-semibold ${M(b)}`;const P=i.querySelector(".col-desc");P.textContent=o.complaintdescription||"-",P.title=o.complaintdescription||"";const R=new Date(o.submitteddate).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"});i.querySelector(".col-date").textContent=R;const $=o.complainantName||"Unknown User";i.querySelector(".complainant-name").textContent=$,i.querySelector(".complainant-id").textContent=o.complainantid||"";const T=i.querySelector(".col-status");T.textContent=o.complaintstatus;const _=c=>c==="Pending"?"bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300":c==="In-Progress"?"bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300":c==="Resolved"?"bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300":c==="Deleted"?"bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-400":"bg-gray-100 text-gray-600";T.className=`col-status py-1 px-3 rounded-full text-xs font-semibold ${_(o.complaintstatus)}`;const A=c=>{const q=c.querySelector(".btn-preview"),u=c.querySelector(".btn-status"),C=c.querySelector(".btn-delete");q&&(q.onclick=()=>window.location.href=`AdminComplaintDetails.html?id=${o.complaintid}`),u&&(u.onclick=()=>pt(o.complaintid,o.complaintstatus)),C&&(C.onclick=()=>deleteComplaint(o.complaintid))};if(A(i),l.appendChild(i),e){const c=document.getElementById("complaintCardTemplate");if(c){const u=c.content.cloneNode(!0).querySelector("div");u.querySelector(".card-category").textContent=b,u.querySelector(".card-category").className=`card-category px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${M(b)}`,u.querySelector(".card-title").textContent=o.complainttitle||"Untitled",u.querySelector(".card-user").textContent=$,u.querySelector(".card-id").textContent=o.complainantid||"N/A",u.querySelector(".card-date").textContent=R;const C=u.querySelector(".card-status");C.textContent=o.complaintstatus,C.className=`card-status px-2 py-0.5 rounded text-[10px] font-bold uppercase ${_(o.complaintstatus)}`;const F=u.querySelector(".card-desc");F.textContent=o.complaintdescription||"No description provided.",F.title=o.complaintdescription||"",A(u),s.appendChild(u)}}}),t&&t.appendChild(l),e&&e.appendChild(s)}const j=document.getElementById("statusModal"),z=document.getElementById("deleteModal"),J=document.getElementById("modalStatusSelect"),K=document.getElementById("modalStatusReason"),Q=document.getElementById("modalDeleteReason"),it=document.getElementById("confirmStatusBtn"),ct=document.getElementById("cancelStatusBtn"),lt=document.getElementById("confirmDeleteBtn"),st=document.getElementById("cancelDeleteBtn");let h=null;function dt(t,e){h=t,J.value=e,K.value="",j.classList.remove("hidden")}function V(){j.classList.add("hidden"),h=null}function mt(t){h=t,Q.value="",z.classList.remove("hidden")}function O(){z.classList.add("hidden"),h=null}ut();function ut(){ct.addEventListener("click",V),it.addEventListener("click",async()=>{const t=J.value,e=K.value.trim();if(!e){alert("Please provide a reason for the status change.");return}await gt(h,t,e),V()}),st.addEventListener("click",O),lt.addEventListener("click",async()=>{const t=Q.value.trim();if(!t){alert("Please provide a reason for deletion.");return}await ft(h,t),O()})}async function pt(t,e,n){dt(t,e)}async function gt(t,e,n){try{const r={complaintstatus:e,admin_feedback:n};e==="Resolved"&&(r.resolveddate=new Date().toISOString(),r.resolvedby=k);const{error:a}=await p.from("complaint").update(r).eq("complaintid",t);if(a)throw a;const l=d.find(s=>s.complaintid===t);if(l&&l.complainantid){const s=`Your complaint "${l.complainttitle||"Complaint"}" status has been updated to ${e}. Reason: ${n}`;await p.from("notifications").insert([{userid:l.complainantid,complaint_id:t,type:e,message:s,is_read:!1}])}d=d.map(s=>s.complaintid===t?{...s,...r}:s),y(),alert(`Status updated to ${e} and user notified!`)}catch(r){console.error("Error updating status:",r),alert("Failed to update status.")}}window.deleteComplaint=t=>{mt(t)};async function ft(t,e){try{const{error:n}=await p.from("complaint").update({complaintstatus:"Deleted",admin_feedback:e}).eq("complaintid",t);if(n)throw n;const r=d.find(a=>a.complaintid===t);if(r&&r.complainantid){const a=`Your complaint "${r.complainttitle||"Complaint"}" was marked as Deleted. Reason: ${e}`;await p.from("notifications").insert([{userid:r.complainantid,complaint_id:t,type:"Deleted",message:a,is_read:!1}])}d=d.map(a=>a.complaintid===t?{...a,complaintstatus:"Deleted",admin_feedback:e}:a),y(),X(),alert("Complaint deleted and user notified.")}catch(n){console.error("Error deleting complaint:",n),alert("Failed to delete complaint.")}}function y(){const t=Y.value.toLowerCase(),e=v.value;f=d.filter(n=>{const r=n.complainttitle&&n.complainttitle.toLowerCase().includes(t)||n.complaintdescription&&n.complaintdescription.toLowerCase().includes(t)||n.complaintid&&n.complaintid.toString().includes(t)||n.complainantName&&n.complainantName.toLowerCase().includes(t),a=e===""||n.complaintstatus===e,l=x?x.value:"",s=l===""||n.categoryName===l;return r&&a&&s}),m=1,I(),N()}function N(){L.textContent="";const t=Math.ceil(f.length/B);if(G.disabled=m===1,W.disabled=m===t||t===0,window.innerWidth<1280){const n=document.createElement("span");n.className="px-4 py-1 text-sm font-medium text-gray-600 dark:text-gray-300",n.textContent=`Page ${m} of ${t}`,L.appendChild(n);return}if(t<=5+2)for(let n=1;n<=t;n++)w(n);else{w(1),m>3&&H();const n=Math.max(2,m-1),r=Math.min(t-1,m+1);for(let a=n;a<=r;a++)w(a);m<t-2&&H(),w(t)}}function w(t){const e=document.createElement("button");e.textContent=t,e.className=`px-3 py-1 border rounded transition ${m===t?"bg-eco text-white border-eco":"hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-white"}`,e.addEventListener("click",()=>{m=t,I(),N()}),L.appendChild(e)}function H(){const t=document.createElement("span");t.textContent="...",t.className="px-2 py-1 text-gray-500 dark:text-gray-400",L.appendChild(t)}function yt(){Y.addEventListener("input",y),v.addEventListener("change",y),x&&x.addEventListener("change",y),G.addEventListener("click",()=>{m>1&&(m--,I(),N())}),W.addEventListener("click",()=>{const e=Math.ceil(f.length/B);m<e&&(m++,I(),N())});const t=document.getElementById("headerLogoutBtn");t&&t.addEventListener("click",xt)}async function xt(){const{error:t}=await p.auth.signOut();t?(console.error("Error signing out:",t),alert("Failed to log out.")):window.location.href="Login.html"}function X(){U&&(U.textContent=d.length)}
