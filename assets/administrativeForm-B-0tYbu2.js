import{s as r}from"./darkMode-0kXEi02e.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:l}}=await r.auth.getSession();if(!l||!l.user){window.location.href="Login.html";return}const y=document.getElementById("adminComplaintForm"),o=document.getElementById("description"),c=document.getElementById("previousAttempts"),d=document.getElementById("fileDesc"),m=document.getElementById("staffInvolved"),F=document.getElementById("declaration"),h=document.getElementById("adminType"),E=document.getElementById("descCounter"),w=document.getElementById("attemptCounter"),I=document.getElementById("fileCounter");function a(t){return t.trim().split(/\s+/).filter(Boolean).length}function u(t,e,n){t.addEventListener("input",()=>{let i=a(t.value);if(i>n){const s=t.value.split(/\s+/).slice(0,n).join(" ");t.value=s,i=n}e.textContent=`${i} / ${n} words`})}u(o,E,500),u(c,w,100),u(d,I,100);let p=l;if(!p||!p.user){window.location.href="Login.html";return}const L=p.user.id;y.addEventListener("submit",async t=>{t.preventDefault();let e=[];const n=document.getElementById("complaintTitle").value.trim();if(n?/^[A-Za-z0-9\s]+$/.test(n)||e.push("Complaint title can only contain letters, numbers, and spaces."):e.push("Complaint title is required."),h.value||e.push("Please select a Type of Administration."),o.value.trim()||e.push("Description is required."),F.checked||e.push("You must declare that the information provided is accurate."),m.value.trim()&&!/^[a-zA-Z0-9\s]+$/.test(m.value)&&e.push("Staff Involved can only contain letters, numbers, and spaces."),a(o.value)>500&&e.push("Description cannot exceed 500 words."),a(c.value)>100&&e.push("Previous attempts cannot exceed 100 words."),a(d.value)>100&&e.push("File description cannot exceed 100 words."),e.length>0){alert(e.join(`
`));return}try{const{data:i,error:s}=await r.from("admin").select("id").eq("adminrole","Administrative Admin").single();if(s||!i){console.error("Error fetching Administrative Admin:",s),alert("System Error: Could not find Administrative Admin. Please contact support.");return}const $=i.id,{data:C,error:A}=await r.from("category").select("categoryid").eq("categoryname","Administrative").single();if(A||!C){console.error("Error fetching Administrative category:",A),alert("System Error: Could not find Administrative category. Please contact support.");return}const T=C.categoryid,{data:q,error:D}=await r.from("complaint").insert([{complainantid:L,adminid:$,categoryid:T,submitteddate:new Date().toISOString(),dateofincident:new Date().toISOString(),complainttitle:n,complaintdescription:o.value.trim(),complaintstatus:"Pending"}]).select().single();if(D){console.error("Complaint insert error:",D),alert("Failed to submit complaint. Please try again.");return}const B=q.complaintid,{error:P}=await r.from("administrativecomplaint").insert([{complaintid:B,complaintdepartment:h.value,staffinvolved:m.value.trim()||null,previousattempts:c.value.trim()||null,desiredoutcome:document.getElementById("desiredOutcome").value.trim()||null}]);if(P){console.error("Administrative complaint insert error:",P),alert("Failed to save administrative complaint. Please try again.");return}const f=document.getElementById("file"),O=d.value.trim();if(f.files.length>0)for(let v=0;v<f.files.length;v++){const g=f.files[v],U=`${Date.now()}_${g.name}`,{data:j,error:b}=await r.storage.from("user-uploads").upload(U,g);if(b){console.error("File upload error:",b),alert("File upload failed. Please try again.");return}const{data:z}=r.storage.from("user-uploads").getPublicUrl(j.path),Z=z.publicUrl,{error:S}=await r.from("complaintattachment").insert([{complaintid:B,fileurl:Z,description:O,filename:g.name}]);if(S){console.error("Attachment insert error:",S),alert("Failed to save file info. Please try again.");return}}y.reset(),E.textContent="0 / 500 words",w.textContent="0 / 100 words",I.textContent="0 / 100 words",alert("Administrative complaint submitted successfully!")}catch(i){console.error(i),alert("Something went wrong. Please try again.")}})});
