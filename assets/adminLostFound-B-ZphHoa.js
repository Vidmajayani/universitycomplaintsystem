import{s as m}from"./darkMode-BCgXZOzb.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:T}}=await m.auth.getSession();if(!T){window.location.href="Login.html";return}const{data:Q}=await m.from("admin").select("id, adminrole").eq("id",T.user.id).single();if(!Q){window.location.href="Login.html";return}const w=document.getElementById("itemsTableBody"),S=document.getElementById("itemsCardsView"),Y=document.getElementById("itemCardTemplate"),b=document.getElementById("statusFilter"),Z=document.getElementById("itemRowTemplate"),q=document.getElementById("emptyTableStateTemplate"),N=document.getElementById("emptyCardStateTemplate");document.getElementById("errorTableStateTemplate");let B=[];K();const F=document.getElementById("filterDateFrom"),$=document.getElementById("filterDateTo"),R=document.getElementById("searchInput"),H=document.getElementById("prevPage"),P=document.getElementById("nextPage"),A=document.getElementById("paginationNumbers");let d=1;const x=10;F.addEventListener("change",()=>{d=1,g()}),$.addEventListener("change",()=>{d=1,g()}),b.addEventListener("change",()=>{d=1,g()}),R.addEventListener("input",()=>{d=1,g()}),H.addEventListener("click",()=>{d>1&&(d--,g())}),P.addEventListener("click",()=>{d++,g()});const v=new URLSearchParams(window.location.search).get("status");v&&Array.from(b.options).some(o=>o.value===v)&&(b.value=v),await C();async function C(){const{data:e,error:o}=await m.from("lost_and_found").select("*").neq("status","Deleted").order("reported_date",{ascending:!1});if(o){console.error(o),w.innerHTML="";const a=document.getElementById("errorTableStateTemplate");a?w.appendChild(a.content.cloneNode(!0)):w.innerHTML='<tr><td colspan="7" class="text-center py-6 text-red-500">Error loading items</td></tr>';return}B=e,document.getElementById("totalItemsCount").innerText=B.length,g()}function g(){w.innerHTML="",S.innerHTML="";const e=b.value,o=F.value,a=$.value,n=R.value.toLowerCase();let s=B.filter(t=>{const I=e==="all"||t.status===e;let h=!0;if(o||a){const L=new Date(t.reported_date);if(L.setHours(0,0,0,0),o){const p=new Date(o);p.setHours(0,0,0,0),L<p&&(h=!1)}if(a&&h){const p=new Date(a);p.setHours(0,0,0,0),L>p&&(h=!1)}}const M=(t.item_name||"").toLowerCase().includes(n)||(t.description||"").toLowerCase().includes(n)||(t.item_id||"").toLowerCase().includes(n)||(t.location_lost||"").toLowerCase().includes(n);return I&&h&&M});const l=s.length,y=Math.ceil(l/x);d>y&&(d=y||1),d<1&&(d=1);const r=(d-1)*x,i=Math.min(r+x,l),_=s.slice(r,i);if(document.getElementById("startRange").textContent=l===0?0:r+1,document.getElementById("endRange").textContent=i,document.getElementById("totalEntries").textContent=l,G(y),s.length===0){z();return}_.forEach(t=>{t.date_lost&&new Date(t.date_lost).toLocaleDateString();const I=t.reported_date?new Date(t.reported_date).toLocaleDateString():"N/A",h=t.location_lost||"Unknown",M=t.brand?`Brand: ${t.brand}`:"",L=t.primary_color?`Color: ${t.primary_color}`:"",p=[M,L].filter(Boolean).join(", ")||"-";let E="bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-300";t.status==="Lost"&&(E="bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300"),t.status==="Claim"&&(E="bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300"),t.status==="Found"&&(E="bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"),t.status==="Deleted"&&(E="bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300");const c=Z.content.cloneNode(!0);c.querySelector(".item-name").textContent=t.item_name,c.querySelector(".item-type").textContent=t.item_type,c.querySelector(".item-location").textContent=h,c.querySelector(".item-date").textContent=I,c.querySelector(".item-attributes").textContent=p;const W=c.querySelector(".item-status");W.textContent=t.status,W.className=`item-status px-3 py-1 rounded-full text-xs font-bold ${E}`,c.querySelector(".btn-edit").onclick=()=>window.openStatusModal(t.item_id,t.status),c.querySelector(".btn-preview").href=`AdminLostFoundDetails.html?id=${t.item_id}`,c.querySelector(".btn-delete").onclick=()=>window.openDeleteModal(t.item_id),w.appendChild(c);const u=Y.content.cloneNode(!0);u.querySelector(".card-type").textContent=t.item_type,u.querySelector(".card-title").textContent=t.item_name,u.querySelector(".card-location span").textContent=h,u.querySelector(".card-date").textContent=I;const J=u.querySelector(".card-status");J.textContent=t.status,J.className=`card-status px-2 py-0.5 rounded text-[10px] font-bold uppercase ${E}`,u.querySelector(".card-attr").textContent=p,u.querySelector(".btn-edit").onclick=()=>window.openStatusModal(t.item_id,t.status),u.querySelector(".Link-preview").href=`AdminLostFoundDetails.html?id=${t.item_id}`,u.querySelector(".btn-delete").onclick=()=>window.openDeleteModal(t.item_id),S.appendChild(u)})}function z(){if(q){const e=q.content.cloneNode(!0);w.appendChild(e)}if(N){const e=N.content.cloneNode(!0);S.appendChild(e)}}function G(e){A.innerHTML="",H.disabled=d===1,P.disabled=d===e||e===0;let o=[];e<=7?o=Array.from({length:e},(a,n)=>n+1):d<=4?o=[1,2,3,4,5,"...",e]:d>=e-3?o=[1,"...",e-4,e-3,e-2,e-1,e]:o=[1,"...",d-1,d,d+1,"...",e],o.forEach(a=>{const n=document.createElement("button");n.className=`px-3 py-1 border rounded ${a===d?"bg-blue-600 text-white border-blue-600":"hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-white"}`,a==="..."?(n.textContent="...",n.disabled=!0,n.classList.add("cursor-default","border-none")):(n.textContent=a,n.onclick=()=>{d=a,g()}),A.appendChild(n)})}const k=document.getElementById("statusModal"),D=document.getElementById("deleteModal"),j=document.getElementById("modalStatusSelect"),U=document.getElementById("modalStatusReason"),V=document.getElementById("modalDeleteReason");let f=null;window.openStatusModal=(e,o)=>{f=e,j.value=o,U.value="",k.classList.remove("hidden")},window.openDeleteModal=e=>{f=e,V.value="",D.classList.remove("hidden")},document.getElementById("cancelStatusBtn").addEventListener("click",()=>k.classList.add("hidden")),document.getElementById("cancelDeleteBtn").addEventListener("click",()=>D.classList.add("hidden")),document.getElementById("confirmStatusBtn").addEventListener("click",async()=>{const e=j.value,o=U.value.trim();if(!o){alert("Please provide a feedback message/reason.");return}try{const{error:a}=await m.from("lost_and_found").update({status:e,admin_feedback:o}).eq("item_id",f);if(a)throw a;const n=B.find(s=>s.item_id===f);n&&n.user_id&&(await m.from("notifications").insert([{userid:n.user_id,type:"LostItemUpdate",message:`Status updated to ${e}. ${o}`,is_read:!1,lost_item_id:f}]),O(n,e,o)),k.classList.add("hidden"),await C(),alert(`Status updated to ${e}`)}catch(a){console.error(a),alert("Failed to update status")}}),document.getElementById("confirmDeleteBtn").addEventListener("click",async()=>{const e=V.value.trim();if(!e){alert("Please provide a reason for deletion.");return}try{const{error:o}=await m.from("lost_and_found").update({status:"Deleted",admin_feedback:e}).eq("item_id",f);if(o)throw o;const a=B.find(n=>n.item_id===f);a&&a.user_id&&(await m.from("notifications").insert([{userid:a.user_id,type:"Deleted",message:`Your report was deleted. Reason: ${e}`,is_read:!1,lost_item_id:f}]),O(a,"Deleted",e)),D.classList.add("hidden"),await C(),alert("Item marked as deleted.")}catch(o){console.error(o),alert("Failed to delete item")}});async function O(e,o,a){try{const{data:n,error:s}=await m.from("users").select("email, first_name").eq("id",e.user_id).single();if(s||!n||!n.email)return;const l={to_name:n.first_name||"Student",to_email:n.email,complaint_title:`Lost Item: ${e.item_name}`,new_status:o,message:a};await emailjs.send("service_q77wg09","template_sb3k70p",l,"08jWWt0PNjZJ4BcQw"),console.log("Email sent successfully")}catch(n){console.error("Failed to send email:",n)}}function K(){const e=document.getElementById("mobileMenuButton"),o=document.getElementById("mobileMenu"),a=document.getElementById("overlay");if(e&&o){const r=e.cloneNode(!0);e.parentNode.replaceChild(r,e),r.addEventListener("click",()=>{o.classList.toggle("-translate-x-full"),a&&a.classList.toggle("hidden")}),a&&a.addEventListener("click",()=>{o.classList.add("-translate-x-full"),a.classList.add("hidden")})}const n=document.getElementById("profileButton"),s=document.getElementById("profileMenu");if(n&&s){const r=n.cloneNode(!0);n.parentNode.replaceChild(r,n),r.addEventListener("click",i=>{i.stopPropagation(),s.classList.contains("hidden")?s.classList.remove("hidden"):s.classList.add("hidden")}),document.addEventListener("click",i=>{!r.contains(i.target)&&!s.contains(i.target)&&s.classList.add("hidden")})}const l=document.getElementById("headerLogoutBtn"),y=document.getElementById("logoutModal");if(l&&y){const r=l.cloneNode(!0);l.parentNode.replaceChild(r,l),r.addEventListener("click",()=>y.classList.remove("hidden"));const i=document.getElementById("cancelLogoutBtn"),_=document.getElementById("confirmLogoutBtn");i&&(i.onclick=()=>y.classList.add("hidden")),_&&(_.onclick=async()=>{await m.auth.signOut(),window.location.href="Login.html"})}}});
