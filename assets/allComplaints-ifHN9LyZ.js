import{s as f}from"./supabaseClient-Du47UBJl.js";/* empty css              */import"./darkMode-DMjetaZp.js";let k=null,B=null,m=[],x=[],P={},u=1;const v=5,b=document.getElementById("complaintsTableBody"),O=document.getElementById("searchInput"),L=document.getElementById("filterStatus"),C=document.getElementById("filterCategory"),U=document.getElementById("totalComplaintsCount"),tt=document.getElementById("startRange"),et=document.getElementById("endRange"),nt=document.getElementById("totalEntries"),W=document.getElementById("prevPage"),J=document.getElementById("nextPage"),I=document.getElementById("paginationNumbers"),at=document.getElementById("complaintRowTemplate");document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:t}}=await f.auth.getSession();if(!t){window.location.href="Login.html";return}ot(),xt()});async function ot(){const{data:{session:t}}=await f.auth.getSession();if(!t){window.location.href="Login.html";return}const{data:e,error:n}=await f.from("admin").select("id, adminrole, profile_pic").eq("id",t.user.id).single();if(n||!e){alert("Access denied."),window.location.href="Login.html";return}k=e.id,B=e.adminrole;const a=document.getElementById("profileButton");a&&e.profile_pic&&(a.innerHTML=`
            <img src="${e.profile_pic}" alt="Profile" class="h-10 w-10 rounded-full object-cover border-2 border-white dark:border-gray-600 shadow-sm">
        `),console.log(`Logged in as Admin: ${B} (${k})`),B==="Master Admin"&&C&&C.classList.remove("hidden"),await it();const l=new URLSearchParams(window.location.search).get("status");l&&L&&(L.value=l),rt()}async function rt(){try{b.textContent="";const t=document.createElement("tr"),e=document.createElement("td");e.colSpan=7,e.className="py-6 text-center",e.textContent="Loading complaints...",t.appendChild(e),b.appendChild(t);let n=f.from("complaint").select("*");B!=="Master Admin"&&(n=n.eq("adminid",k)),n=n.neq("complaintstatus","Deleted");const{data:a,error:r}=await n.order("submitteddate",{ascending:!1});if(r)throw r;if(m=a||[],m=m.map(l=>({...l,categoryName:P[l.categoryid]||"Unknown Category"})),m.length>0){const l=[...new Set(m.map(i=>i.complainantid))],{data:c,error:o}=await f.from("users").select("id, first_name, last_name, email").in("id",l);if(!o&&c){const i={};c.forEach(d=>{i[d.id]={name:`${d.first_name} ${d.last_name}`,email:d.email}}),m=m.map(d=>{const p=i[d.complainantid];return{...d,complainantName:p?p.name:"Unknown User",complainantEmail:p?p.email:null}})}}X(),h()}catch(t){console.error("Error loading complaints:",t),b.textContent="";const e=document.createElement("tr"),n=document.createElement("td");n.colSpan=7,n.className="py-6 text-center text-red-500",n.textContent="Error loading complaints. Please try again.",e.appendChild(n),b.appendChild(e)}}async function it(){try{const{data:t,error:e}=await f.from("category").select("categoryid, categoryname");if(e)throw e;t&&(t.forEach(n=>{P[n.categoryid]=n.categoryname}),console.log("Categories loaded:",P))}catch(t){console.error("Error fetching categories:",t)}}function D(){const t=document.getElementById("complaintsTableBody"),e=document.getElementById("complaintsCardsView");if(t&&(t.textContent=""),e&&(e.textContent=""),x.length===0){if(t){const o=document.createElement("tr"),i=document.createElement("td");i.colSpan=7,i.className="py-8 text-center text-gray-500 dark:text-gray-400",i.innerHTML='<i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i><br>No complaints found.',o.appendChild(i),t.appendChild(o)}e&&(e.innerHTML=`
                <div class="col-span-full py-8 text-center text-gray-500 dark:text-gray-400">
                    <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i><br>No complaints found.
                </div>
            `);return}const n=(u-1)*v,a=Math.min(n+v,x.length),r=x.slice(n,a);tt.textContent=x.length>0?n+1:0,et.textContent=a,nt.textContent=x.length;const l=document.createDocumentFragment(),c=document.createDocumentFragment();r.forEach(o=>{const i=at.content.cloneNode(!0);i.querySelector("tr"),i.querySelector(".col-title").textContent=o.complainttitle||"Untitled";const d=i.querySelector(".col-category"),p=o.categoryName||"General";d.textContent=p;const y=s=>s==="Academic"?"bg-purple-100 text-purple-600 dark:bg-purple-900 dark:text-purple-300":s==="Facility"?"bg-orange-100 text-orange-600 dark:bg-orange-900 dark:text-orange-300":s==="Technical"?"bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300":s==="Administrative"?"bg-pink-100 text-pink-600 dark:bg-pink-900 dark:text-pink-300":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300";d.className=`col-category inline-block px-3 py-1 rounded-full text-xs font-semibold ${y(p)}`;const M=i.querySelector(".col-desc");M.textContent=o.complaintdescription||"-",M.title=o.complaintdescription||"";const _=new Date(o.submitteddate).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"});i.querySelector(".col-date").textContent=_;const $=o.complainantName||"Unknown User";i.querySelector(".complainant-name").textContent=$,i.querySelector(".complainant-id").textContent=o.complainantid||"";const R=i.querySelector(".col-status");R.textContent=o.complaintstatus;const T=s=>s==="Pending"?"bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300":s==="In-Progress"?"bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300":s==="Resolved"?"bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300":s==="Deleted"?"bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-400":"bg-gray-100 text-gray-600";R.className=`col-status py-1 px-3 rounded-full text-xs font-semibold ${T(o.complaintstatus)}`;const F=s=>{const q=s.querySelector(".btn-preview"),g=s.querySelector(".btn-status"),w=s.querySelector(".btn-delete");q&&(q.onclick=()=>window.location.href=`AdminComplaintDetails.html?id=${o.complaintid}`),g&&(g.onclick=()=>gt(o.complaintid,o.complaintstatus)),w&&(w.onclick=()=>deleteComplaint(o.complaintid))};if(F(i),l.appendChild(i),e){const s=document.getElementById("complaintCardTemplate");if(s){const g=s.content.cloneNode(!0).querySelector("div");g.querySelector(".card-category").textContent=p,g.querySelector(".card-category").className=`card-category px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${y(p)}`,g.querySelector(".card-title").textContent=o.complainttitle||"Untitled",g.querySelector(".card-user").textContent=$,g.querySelector(".card-id").textContent=o.complainantid||"N/A",g.querySelector(".card-date").textContent=_;const w=g.querySelector(".card-status");w.textContent=o.complaintstatus,w.className=`card-status px-2 py-0.5 rounded text-[10px] font-bold uppercase ${T(o.complaintstatus)}`;const A=g.querySelector(".card-desc");A.textContent=o.complaintdescription||"No description provided.",A.title=o.complaintdescription||"",F(g),c.appendChild(g)}}}),t&&t.appendChild(l),e&&e.appendChild(c)}const Y=document.getElementById("statusModal"),G=document.getElementById("deleteModal"),Q=document.getElementById("modalStatusSelect"),Z=document.getElementById("modalStatusReason"),z=document.getElementById("modalDeleteReason"),lt=document.getElementById("confirmStatusBtn"),ct=document.getElementById("cancelStatusBtn"),st=document.getElementById("confirmDeleteBtn"),dt=document.getElementById("cancelDeleteBtn");let E=null;function mt(t,e){E=t,Q.value=e,Z.value="",Y.classList.remove("hidden")}function H(){Y.classList.add("hidden"),E=null}function ut(t){E=t,z.value="",G.classList.remove("hidden")}function j(){G.classList.add("hidden"),E=null}pt();function pt(){ct.addEventListener("click",H),lt.addEventListener("click",async()=>{const t=Q.value,e=Z.value.trim();if(!e){alert("Please provide a reason for the status change.");return}await ft(E,t,e),H()}),dt.addEventListener("click",j),st.addEventListener("click",async()=>{const t=z.value.trim();if(!t){alert("Please provide a reason for deletion.");return}await yt(E,t),j()})}async function gt(t,e,n){mt(t,e)}async function ft(t,e,n){try{const a={complaintstatus:e,admin_feedback:n};e==="Resolved"&&(a.resolveddate=new Date().toISOString(),a.resolvedby=k);const{error:r}=await f.from("complaint").update(a).eq("complaintid",t);if(r)throw r;const l=m.find(c=>c.complaintid===t);if(l&&l.complainantid){const c=`Your complaint "${l.complainttitle||"Complaint"}" status has been updated to ${e}. Reason: ${n}`;await f.from("notifications").insert([{userid:l.complainantid,complaint_id:t,type:e,message:c,is_read:!1}]),await K(l.complainantEmail,l.complainantName,l.complainttitle,e,n)}m=m.map(c=>c.complaintid===t?{...c,...a}:c),h(),alert(`Status updated to ${e} and user notified!`)}catch(a){console.error("Error updating status:",a),alert("Failed to update status.")}}async function K(t,e,n,a,r){if(!t){console.warn("No email found for user. Skipping email notification.");return}const l={to_name:e,to_email:t,complaint_title:n,new_status:a,message:r};try{await emailjs.send("service_q77wg09","template_sb3k70p",l,"08jWWt0PNjZJ4BcQw"),console.log(`Email sent to ${t}`)}catch(c){console.error("EmailJS Error:",c)}}window.deleteComplaint=t=>{ut(t)};async function yt(t,e){try{const{error:n}=await f.from("complaint").update({complaintstatus:"Deleted",admin_feedback:e}).eq("complaintid",t);if(n)throw n;const a=m.find(r=>r.complaintid===t);if(a&&a.complainantid){const r=`Your complaint "${a.complainttitle||"Complaint"}" was marked as Deleted. Reason: ${e}`;await f.from("notifications").insert([{userid:a.complainantid,complaint_id:t,type:"Deleted",message:r,is_read:!1}]),await K(a.complainantEmail,a.complainantName,a.complainttitle,"Deleted",e)}m=m.map(r=>r.complaintid===t?{...r,complaintstatus:"Deleted",admin_feedback:e}:r),h(),X(),alert("Complaint deleted and user notified.")}catch(n){console.error("Error deleting complaint:",n),alert("Failed to delete complaint.")}}function h(){const t=O.value.toLowerCase(),e=L.value;x=m.filter(n=>{const a=n.complainttitle&&n.complainttitle.toLowerCase().includes(t)||n.complaintdescription&&n.complaintdescription.toLowerCase().includes(t)||n.complaintid&&n.complaintid.toString().includes(t)||n.complainantName&&n.complainantName.toLowerCase().includes(t),r=e===""||n.complaintstatus===e,l=C?C.value:"",c=l===""||n.categoryName===l,o=document.getElementById("filterDateFrom").value,i=document.getElementById("filterDateTo").value;let d=!0;if(o||i){const p=new Date(n.submitteddate);if(p.setHours(0,0,0,0),o){const y=new Date(o);y.setHours(0,0,0,0),p<y&&(d=!1)}if(i&&d){const y=new Date(i);y.setHours(0,0,0,0),p>y&&(d=!1)}}return a&&r&&c&&d}),u=1,D(),N()}function N(){I.textContent="";const t=Math.ceil(x.length/v);if(W.disabled=u===1,J.disabled=u===t||t===0,window.innerWidth<1280){const n=document.createElement("span");n.className="px-4 py-1 text-sm font-medium text-gray-600 dark:text-gray-300",n.textContent=`Page ${u} of ${t}`,I.appendChild(n);return}if(t<=5+2)for(let n=1;n<=t;n++)S(n);else{S(1),u>3&&V();const n=Math.max(2,u-1),a=Math.min(t-1,u+1);for(let r=n;r<=a;r++)S(r);u<t-2&&V(),S(t)}}function S(t){const e=document.createElement("button");e.textContent=t,e.className=`px-3 py-1 border rounded transition ${u===t?"bg-eco text-white border-eco":"hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-white"}`,e.addEventListener("click",()=>{u=t,D(),N()}),I.appendChild(e)}function V(){const t=document.createElement("span");t.textContent="...",t.className="px-2 py-1 text-gray-500 dark:text-gray-400",I.appendChild(t)}function xt(){O.addEventListener("input",h),L.addEventListener("change",h),C&&C.addEventListener("change",h);const t=document.getElementById("filterDateFrom"),e=document.getElementById("filterDateTo");t&&t.addEventListener("change",h),e&&e.addEventListener("change",h),W.addEventListener("click",()=>{u>1&&(u--,D(),N())}),J.addEventListener("click",()=>{const a=Math.ceil(x.length/v);u<a&&(u++,D(),N())});const n=document.getElementById("headerLogoutBtn");n&&n.addEventListener("click",ht)}async function ht(){const{error:t}=await f.auth.signOut();t?(console.error("Error signing out:",t),alert("Failed to log out.")):window.location.href="Login.html"}function X(){U&&(U.textContent=m.length)}
