import{s as n}from"./darkMode-DwWyDh1G.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:l}}=await n.auth.getSession();if(!l||!l.user){window.location.href="Login.html";return}const f=document.getElementById("otherComplaintForm"),i=document.getElementById("dateIncident"),s=document.getElementById("description"),g=document.getElementById("fileDesc"),y=document.getElementById("previousAttempt"),P=document.getElementById("declaration"),A=document.getElementById("desiredOutcome"),F=document.getElementById("category"),h=document.getElementById("descCounter"),E=document.getElementById("fileCounter"),I=document.getElementById("attemptCounter"),L=new Date().toISOString().split("T")[0];i.setAttribute("max",L);function $(t){return t.trim().split(/\s+/).filter(Boolean).length}function c(t,e,r){t.addEventListener("input",()=>{let o=$(t.value);o>r&&(t.value=t.value.split(/\s+/).slice(0,r).join(" "),o=r),e.textContent=`${o} / ${r} words`})}c(s,h,500),c(g,E,100),c(y,I,100);let d=l;if(!d||!d.user){window.location.href="Login.html";return}const q=d.user.id;f.addEventListener("submit",async t=>{t.preventDefault();let e=[];const r=document.getElementById("complaintTitle").value.trim();r?/^[A-Za-z0-9\s]+$/.test(r)||e.push("Complaint title can only contain letters, numbers, and spaces."):e.push("Complaint title is required.");const o=new Date().toISOString().split("T")[0];if(i.value?i.value>o&&e.push("Date of Incident cannot be in the future."):e.push("Please select the Date of Incident."),s.value.trim()||e.push("Description is required."),P.checked||e.push("You must declare that the information is accurate."),e.length>0){alert(e.join(`
`));return}try{const{data:a,error:v}=await n.from("admin").select("id").eq("adminrole","General Admin").single();if(v||!a){console.error("Error fetching General Admin:",v),alert("System Error: Could not find General Admin. Please contact support.");return}const T=a.id,{data:w,error:C}=await n.from("category").select("categoryid").eq("categoryname","Other").single();if(C||!w){console.error("Error fetching Other category:",C),alert("System Error: Could not find Other category. Please contact support.");return}const G=w.categoryid,{data:U,error:D}=await n.from("complaint").insert([{complainantid:q,adminid:T,categoryid:G,submitteddate:new Date().toISOString(),dateofincident:i.value,complainttitle:r,complaintdescription:s.value.trim(),complaintstatus:"Pending"}]).select().single();if(D){console.error("Complaint insert error:",D),alert("Failed to submit complaint. Please try again.");return}const B=U.complaintid,{error:b}=await n.from("othercomplaint").insert([{complaintid:B,previousattempts:y.value.trim()||null,suggestedcategory:F.value.trim()||null,desiredoutcome:A.value.trim()||null}]);if(b){console.error("Other complaint insert error:",b),alert("Failed to save other complaint. Please try again.");return}const u=document.getElementById("file"),j=g.value.trim();if(u.files.length>0)for(let m=0;m<u.files.length;m++){const p=u.files[m],x=`${Date.now()}_${p.name}`,{data:k,error:O}=await n.storage.from("user-uploads").upload(x,p);if(O){console.error("File upload error:",O),alert("File upload failed. Please try again.");return}const{data:z}=n.storage.from("user-uploads").getPublicUrl(k.path),M=z.publicUrl,{error:S}=await n.from("complaintattachment").insert([{complaintid:B,fileurl:M,description:j,filename:p.name}]);if(S){console.error("Attachment insert error:",S),alert("Failed to save file info. Please try again.");return}}f.reset(),h.textContent="0 / 500 words",E.textContent="0 / 100 words",I.textContent="0 / 100 words",alert("Other complaint submitted successfully!")}catch(a){console.error(a),alert("Something went wrong. Please try again.")}})});
