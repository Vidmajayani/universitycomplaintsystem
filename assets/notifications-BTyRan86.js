import{s as l}from"./darkMode-U0iCC7-S.js";let f=null;const h=document.getElementById("notificationBtn"),m=document.getElementById("notificationBadge");document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await l.auth.getSession();if(!e){window.location.href="Login.html";return}w();const t=document.getElementById("fullNotificationList");t&&v(t)});async function w(){const{data:{user:e}}=await l.auth.getUser();e&&(f=e,h&&h.addEventListener("click",t=>{t.stopPropagation(),window.location.href="Notifications.html"}),await y())}async function y(){try{const{data:e,error:t}=await l.from("notifications").select("*").eq("userid",f.id).order("created_at",{ascending:!1}).limit(20);if(t){console.warn("Notifications table issue:",t);return}b(e)}catch(e){console.error("Error fetching notifications:",e)}}function b(e){if(!e||e.length===0){m&&m.classList.add("hidden");return}const t=e.filter(i=>!i.is_read).length;t>0&&m?(m.textContent=t>9?"9+":t,m.classList.remove("hidden")):m&&m.classList.add("hidden")}async function v(e){if(!f){const{data:{user:i}}=await l.auth.getUser();i&&(f=i)}if(!f)return;const t=document.getElementById("markAllReadPageBtn");t&&(t.onclick=async()=>{await l.from("notifications").update({is_read:!0}).eq("userid",f.id),L(e),y()}),L(e)}async function L(e){e.innerHTML="";const t=document.getElementById("notificationsLoadingTemplate");t?e.appendChild(t.content.cloneNode(!0)):e.textContent="Loading notifications...";const{data:i,error:a}=await l.from("notifications").select("*").eq("userid",f.id).order("created_at",{ascending:!1});if(a||!i){e.innerHTML="";const o=document.getElementById("notificationsErrorTemplate");o?e.appendChild(o.content.cloneNode(!0)):e.textContent="Failed to load notifications.";return}if(i.length===0){e.innerHTML="";const o=document.getElementById("notificationsEmptyTemplate");o?e.appendChild(o.content.cloneNode(!0)):e.textContent="You have no notifications.";return}e.innerHTML="",i.forEach(o=>{const n=T(o);e.appendChild(n)})}function T(e){const t=document.getElementById("notificationItemTemplate");if(!t)return null;const i=t.content.cloneNode(!0),a=i.querySelector(".notification-card"),o=e.type==="Resolved"||e.type==="resolved",n=`timeline-${e.id}`,r=e.is_read?["bg-white","dark:bg-gray-800","opacity-90"]:["bg-[var(--color-eco-light)]","dark:bg-[var(--color-green-dark)]"];a.classList.add(...r);const s=i.querySelector(".notification-icon");let d="fa-info-circle text-[var(--color-blue-btn)]";o&&(d="fa-check-circle text-resolved"),(e.type==="Deleted"||e.type==="deleted")&&(d="fa-trash-alt text-pending"),s.className=`notification-icon fas ${d}`,i.querySelector(".notification-message").textContent=e.message,i.querySelector(".notification-date").textContent=new Date(e.created_at).toLocaleString();const c=i.querySelector(".notification-chevron"),u=i.querySelector(".notification-timeline");return["In-Progress","Resolved","Pending","Deleted","in-progress","resolved","pending","deleted"].includes(e.type)&&(c.classList.remove("hidden"),u.id=n,c.onclick=g=>{g.stopPropagation(),E(e.complaint_id,u,c,e.created_at)}),a.onclick=async g=>{g.target.closest("button")||g.target.closest(`#${n}`)||e.is_read||(await l.from("notifications").update({is_read:!0}).eq("id",e.id),a.classList.remove("bg-[var(--color-eco-light)]","dark:bg-[var(--color-green-dark)]"),a.classList.add("bg-white","dark:bg-gray-800","opacity-90"),y())},a}async function E(e,t,i,a){if(t.classList.contains("hidden")){if(t.classList.remove("hidden"),i.classList.add("rotate-180"),!t.dataset.loaded){t.innerHTML="";const n=document.getElementById("timelineLoadingTemplate");n?t.appendChild(n.content.cloneNode(!0)):t.textContent="Loading history...";try{const{data:r,error:s}=await l.from("complaint").select("submitteddate, complainttitle").eq("complaintid",e).single();if(s)throw s;const{data:d,error:c}=await l.from("notifications").select("*").eq("complaint_id",e).lte("created_at",a).order("created_at",{ascending:!0});if(c)throw c;const u={type:"Pending",created_at:r.submitteddate,message:`Complaint "${r.complainttitle||"Submitted"}" was received.`},p=d.filter(C=>C.type!=="Pending"),g=[u,...p];S(t,g),t.dataset.loaded="true"}catch(r){console.error("Timeline error:",r),t.innerHTML="";const s=document.getElementById("timelineErrorTemplate");s?t.appendChild(s.content.cloneNode(!0)):t.textContent="Failed to load history."}}}else t.classList.add("hidden"),i.classList.remove("rotate-180")}function S(e,t){if(e.innerHTML="",!t||t.length===0){e.textContent="No history found.";return}const i=document.createElement("div");i.className="space-y-4";const a=document.getElementById("timelineItemTemplate");t.forEach(o=>{let n="bg-gray-400",r=o.type||"Update";o.type==="Pending"?(n="bg-red-500",r="Complaint Submitted"):o.type==="In-Progress"?(n="bg-yellow-500",r="In Progress"):o.type==="Resolved"?(n="bg-green-500",r="Resolved"):o.type==="Deleted"&&(n="bg-gray-500",r="Deleted");let s=o.message||"";if(s.includes("Reason:")&&(s=s.split("Reason:")[1].trim()),a){const d=a.content.cloneNode(!0),c=d.querySelector(".timeline-dot");c.className=`timeline-dot w-3 h-3 rounded-full mt-1.5 border-2 border-white dark:border-gray-800 ${n}`;const u=new Date(o.created_at).toLocaleDateString(),p=new Date(o.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});d.querySelector(".timeline-date").textContent=`${u} â€¢ ${p}`,d.querySelector(".timeline-title").textContent=r,d.querySelector(".timeline-message").textContent=s,i.appendChild(d)}}),e.appendChild(i)}
