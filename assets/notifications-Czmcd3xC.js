import{s as d}from"./supabaseClient-C2pcRdcq.js";let f=null;const h=document.getElementById("notificationBtn"),m=document.getElementById("notificationBadge");document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await d.auth.getSession();if(!e){window.location.href="Login.html";return}C();const t=document.getElementById("fullNotificationList");t&&v(t)});async function C(){const{data:{user:e}}=await d.auth.getUser();e&&(f=e,h&&h.addEventListener("click",t=>{t.stopPropagation(),window.location.href="Notifications.html"}),await y())}async function y(){try{const{data:e,error:t}=await d.from("notifications").select("*").eq("userid",f.id).order("created_at",{ascending:!1}).limit(20);if(t){console.warn("Notifications table issue:",t);return}w(e)}catch(e){console.error("Error fetching notifications:",e)}}function w(e){if(!e||e.length===0){m&&m.classList.add("hidden");return}const t=e.filter(n=>!n.is_read).length;t>0&&m?(m.textContent=t>9?"9+":t,m.classList.remove("hidden")):m&&m.classList.add("hidden")}async function v(e){if(!f){const{data:{user:i}}=await d.auth.getUser();i&&(f=i)}if(!f)return;const t=document.getElementById("markAllReadPageBtn");t&&(t.onclick=async()=>{await d.from("notifications").update({is_read:!0}).eq("userid",f.id),L(e),y()});const n=document.getElementById("mobileMenuButton"),o=document.getElementById("mobileMenu");n&&o&&(n.onclick=()=>{!o.classList.contains("-translate-x-full")?o.classList.add("-translate-x-full"):o.classList.remove("-translate-x-full")},document.addEventListener("click",i=>{!o.contains(i.target)&&!n.contains(i.target)&&o.classList.add("-translate-x-full")})),L(e)}async function L(e){e.innerHTML="";const t=document.getElementById("notificationsLoadingTemplate");t?e.appendChild(t.content.cloneNode(!0)):e.textContent="Loading notifications...";const{data:n,error:o}=await d.from("notifications").select("*").eq("userid",f.id).order("created_at",{ascending:!1});if(o||!n){e.innerHTML="";const i=document.getElementById("notificationsErrorTemplate");i?e.appendChild(i.content.cloneNode(!0)):e.textContent="Failed to load notifications.";return}if(n.length===0){e.innerHTML="";const i=document.getElementById("notificationsEmptyTemplate");i?e.appendChild(i.content.cloneNode(!0)):e.textContent="You have no notifications.";return}e.innerHTML="",n.forEach(i=>{const a=E(i);e.appendChild(a)})}function E(e){const t=document.getElementById("notificationItemTemplate");if(!t)return null;const n=t.content.cloneNode(!0),o=n.querySelector(".notification-card"),i=e.type==="Resolved"||e.type==="resolved",a=`timeline-${e.id}`,s=e.is_read?["bg-white","dark:bg-gray-800","opacity-90"]:["bg-[var(--color-eco-light)]","dark:bg-[var(--color-green-dark)]"];o.classList.add(...s);const r=n.querySelector(".notification-icon");let l="fa-info-circle text-[var(--color-blue-btn)]";i&&(l="fa-check-circle text-resolved"),(e.type==="Deleted"||e.type==="deleted")&&(l="fa-trash-alt text-pending"),r.className=`notification-icon fas ${l}`,n.querySelector(".notification-message").textContent=e.message,n.querySelector(".notification-date").textContent=new Date(e.created_at).toLocaleString();const c=n.querySelector(".notification-chevron"),u=n.querySelector(".notification-timeline");return["In-Progress","Resolved","Pending","Deleted","in-progress","resolved","pending","deleted"].includes(e.type)&&(c.classList.remove("hidden"),u.id=a,c.onclick=g=>{g.stopPropagation(),T(e.complaint_id,u,c,e.created_at)}),o.onclick=async g=>{g.target.closest("button")||g.target.closest(`#${a}`)||e.is_read||(await d.from("notifications").update({is_read:!0}).eq("id",e.id),o.classList.remove("bg-[var(--color-eco-light)]","dark:bg-[var(--color-green-dark)]"),o.classList.add("bg-white","dark:bg-gray-800","opacity-90"),y())},o}async function T(e,t,n,o){if(t.classList.contains("hidden")){if(t.classList.remove("hidden"),n.classList.add("rotate-180"),!t.dataset.loaded){t.innerHTML="";const a=document.getElementById("timelineLoadingTemplate");a?t.appendChild(a.content.cloneNode(!0)):t.textContent="Loading history...";try{const{data:s,error:r}=await d.from("complaint").select("submitteddate, complainttitle").eq("complaintid",e).single();if(r)throw r;const{data:l,error:c}=await d.from("notifications").select("*").eq("complaint_id",e).lte("created_at",o).order("created_at",{ascending:!0});if(c)throw c;const u={type:"Pending",created_at:s.submitteddate,message:`Complaint "${s.complainttitle||"Submitted"}" was received.`},p=l.filter(b=>b.type!=="Pending"),g=[u,...p];B(t,g),t.dataset.loaded="true"}catch(s){console.error("Timeline error:",s),t.innerHTML="";const r=document.getElementById("timelineErrorTemplate");r?t.appendChild(r.content.cloneNode(!0)):t.textContent="Failed to load history."}}}else t.classList.add("hidden"),n.classList.remove("rotate-180")}function B(e,t){if(e.innerHTML="",!t||t.length===0){e.textContent="No history found.";return}const n=document.createElement("div");n.className="space-y-4";const o=document.getElementById("timelineItemTemplate");t.forEach(i=>{let a="bg-gray-400",s=i.type||"Update";i.type==="Pending"?(a="bg-red-500",s="Complaint Submitted"):i.type==="In-Progress"?(a="bg-yellow-500",s="In Progress"):i.type==="Resolved"?(a="bg-green-500",s="Resolved"):i.type==="Deleted"&&(a="bg-gray-500",s="Deleted");let r=i.message||"";if(r.includes("Reason:")&&(r=r.split("Reason:")[1].trim()),o){const l=o.content.cloneNode(!0),c=l.querySelector(".timeline-dot");c.className=`timeline-dot w-3 h-3 rounded-full mt-1.5 border-2 border-white dark:border-gray-800 ${a}`;const u=new Date(i.created_at).toLocaleDateString(),p=new Date(i.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});l.querySelector(".timeline-date").textContent=`${u} â€¢ ${p}`,l.querySelector(".timeline-title").textContent=s,l.querySelector(".timeline-message").textContent=r,n.appendChild(l)}}),e.appendChild(n)}
