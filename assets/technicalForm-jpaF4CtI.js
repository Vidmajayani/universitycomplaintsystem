import{s as r}from"./supabaseClient-Du47UBJl.js";/* empty css              */const U=5*1024*1024;document.addEventListener("DOMContentLoaded",async()=>{const d=document.getElementById("technicalForm"),u=document.getElementById("issueType"),m=document.getElementById("device"),c=document.getElementById("dateIncident"),l=document.getElementById("description"),p=document.getElementById("fileDesc"),f=document.getElementById("previousAttempts"),b=document.getElementById("declaration"),g=document.getElementById("complaintTitle"),h=document.getElementById("descCounter"),y=document.getElementById("fileCounter"),I=document.getElementById("attemptCounter"),v=new Date().toISOString().split("T")[0];c.max=v;function s(n,t,o){n.addEventListener("input",()=>{let e=n.value.trim().split(/\s+/).filter(Boolean);e.length>o&&(n.value=e.slice(0,o).join(" "),e=e.slice(0,o)),t.textContent=`${e.length} / ${o} words`})}s(l,h,500),s(p,y,100),s(f,I,100);let i=null;try{const{data:n}=await r.auth.getSession();i=n.session}catch(n){console.error("Session error:",n)}if(!i||!i.user){window.location.href="/login.html";return}const A=i.user.id;d.addEventListener("submit",async n=>{n.preventDefault();let t=[];g.value.trim()||t.push("Complaint title is required."),u.value||t.push("Type of Issue is required."),m.value.trim()||t.push("Device / Software Affected is required."),l.value.trim()||t.push("Description of Issue is required."),b.checked||t.push("You must accept the declaration."),c.value>v&&t.push("Date of Issue cannot be in the future.");let e=document.getElementById("file").files[0];if(e&&e.size>U&&t.push("File must be smaller than 5MB."),t.length>0){alert(t.join(`
`));return}try{const{data:a,error:E}=await r.from("admin").select("id").eq("adminrole","Technical Admin").single();if(E||!a){console.error("Error fetching Technical Admin:",E),alert("System Error: Could not find Technical Admin. Please contact support.");return}const F=a.id,{data:w,error:C}=await r.from("category").select("categoryid").eq("categoryname","Technical").single();if(C||!w){console.error("Error fetching Technical category:",C),alert("System Error: Could not find Technical category. Please contact support.");return}const q=w.categoryid,{data:L,error:D}=await r.from("complaint").insert([{complainantid:A,adminid:F,categoryid:q,submitteddate:new Date().toISOString(),dateofincident:c.value,complainttitle:g.value.trim(),complaintdescription:l.value.trim(),complaintstatus:"Pending"}]).select().single();if(D){console.error("Complaint insert failed:",D),alert("Failed to save complaint.");return}const B=L.complaintid,{error:T}=await r.from("technicalcomplaint").insert([{complaintid:B,typeofissue:u.value,deviceaffected:m.value.trim(),previousattempts:f.value.trim()}]);if(T){console.error("Technical insert failed:",T),alert("Failed to save technical complaint.");return}if(e){const P=`${Date.now()}_${e.name}`,{data:$,error:S}=await r.storage.from("user-uploads").upload(P,e);if(S){console.error("File upload error:",S),alert("File upload failed.");return}const{data:M}=r.storage.from("user-uploads").getPublicUrl($.path),O=M.publicUrl;await r.from("complaintattachment").insert([{complaintid:B,fileurl:O,filename:e.name,description:p.value.trim()}])}d.reset(),h.textContent="0 / 500 words",y.textContent="0 / 100 words",I.textContent="0 / 100 words",alert("Technical complaint submitted successfully!")}catch(a){console.error(a),alert("Something went wrong. Please try again.")}})});
