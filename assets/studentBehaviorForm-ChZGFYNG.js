import{s as r}from"./supabaseClient-DP-aSKaS.js";import"./darkMode-DIftV1Qz.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:a}}=await r.auth.getSession();if(!a||!a.user){window.location.href="Login.html";return}const m=document.getElementById("behaviorForm"),l=document.getElementById("description"),p=document.getElementById("location"),f=document.getElementById("fileDetail"),F=document.getElementById("declaration"),L=document.getElementById("involvedStudents"),g=document.getElementById("misconduct"),y=document.getElementById("previousAttempts"),v=document.getElementById("descCounter"),h=document.getElementById("locationCounter"),E=document.getElementById("fileCounter"),w=document.getElementById("attemptCounter");function $(e){return e.trim().split(/\s+/).filter(Boolean).length}function i(e,t,n){e.addEventListener("input",()=>{let o=$(e.value);o>n&&(e.value=e.value.split(/\s+/).slice(0,n).join(" "),o=n),t.textContent=`${o} / ${n} words`})}i(l,v,500),i(p,h,100),i(f,E,100),i(y,w,100);let s=a;if(!s||!s.user){window.location.href="Login.html";return}const q=s.user.id;m.addEventListener("submit",async e=>{e.preventDefault();let t=[];const n=document.getElementById("complaintTitle").value.trim();if(n?/^[A-Za-z0-9\s]+$/.test(n)||t.push("Complaint title can only contain letters, numbers, and spaces."):t.push("Complaint title is required."),g.value||t.push("Please select the Nature of Misconduct."),l.value.trim()||t.push("Description is required."),F.checked||t.push("You must declare that the information is accurate."),t.length>0){alert(t.join(`
`));return}try{const{data:o,error:I}=await r.from("admin").select("id").eq("adminrole","Student Disciplinary Admin").single();if(I||!o){console.error("Error fetching Student Disciplinary Admin:",I),alert("System Error: Could not find Student Disciplinary Admin. Please contact support.");return}const U=o.id,{data:C,error:D}=await r.from("category").select("categoryid").eq("categoryname","Student Disciplinary").single();if(D||!C){console.error("Error fetching Student Disciplinary category:",D),alert("System Error: Could not find Student Disciplinary category. Please contact support.");return}const O=C.categoryid,{data:j,error:S}=await r.from("complaint").insert([{complainantid:q,adminid:U,categoryid:O,submitteddate:new Date().toISOString(),dateofincident:new Date().toISOString(),complainttitle:n,complaintdescription:l.value.trim(),complaintstatus:"Pending"}]).select().single();if(S){console.error("Complaint insert error:",S),alert("Failed to submit complaint. Please try again.");return}const B=j.complaintid,{error:b}=await r.from("studentbehaviorcomplaint").insert([{complaintid:B,accusedname:L.value.trim()||null,typeofbehavior:g.value,locationofincident:p.value.trim(),witnessdetail:document.getElementById("witness").value.trim()||null,previousattempts:y.value.trim()||null}]);if(b){console.error("Student behavior insert error:",b),alert("Failed to save student behavior complaint. Please try again.");return}const c=document.getElementById("fileUpload"),x=f.value.trim();if(c.files.length>0)for(let d=0;d<c.files.length;d++){const u=c.files[d],M=`${Date.now()}_${u.name}`,{data:N,error:P}=await r.storage.from("user-uploads").upload(M,u);if(P){console.error("File upload error:",P),alert("File upload failed. Please try again.");return}const{data:T}=r.storage.from("user-uploads").getPublicUrl(N.path),k=T.publicUrl,{error:A}=await r.from("complaintattachment").insert([{complaintid:B,fileurl:k,description:x,filename:u.name}]);if(A){console.error("Attachment insert error:",A),alert("Failed to save file info. Please try again.");return}}m.reset(),v.textContent="0 / 500 words",h.textContent="0 / 100 words",E.textContent="0 / 100 words",w.textContent="0 / 100 words",alert("Student behavior complaint submitted successfully!")}catch(o){console.error(o),alert("Something went wrong. Please try again.")}})});
