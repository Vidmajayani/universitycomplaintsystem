import{s as l}from"./darkMode-C5bWaft0.js";const N=document.getElementById("complaintTitle"),y=document.getElementById("statusBadge"),_=document.getElementById("complaintId"),S=document.getElementById("submittedDate"),P=document.getElementById("complaintDescription"),q=document.getElementById("categoryDetailsCard"),T=document.getElementById("categoryName"),x=document.getElementById("categoryFields"),U=document.getElementById("category-field-template"),p=document.getElementById("attachmentsContainer"),F=document.getElementById("attachment-item-template"),f=document.getElementById("avatarInitials"),g=document.getElementById("avatarImage"),L=document.getElementById("complainantName"),B=document.getElementById("complainantRole"),h=document.getElementById("complainantId"),k=document.getElementById("complainantEmail"),D=document.getElementById("complainantDept"),A=document.getElementById("feedbackContainer"),E=document.getElementById("adminInitials"),b=document.getElementById("adminProfileImage"),$=document.getElementById("adminName");let C=null;document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:n}}=await l.auth.getSession();if(!n){window.location.href="Login.html";return}if(C=new URLSearchParams(window.location.search).get("id"),!C){alert("No complaint ID provided."),window.location.href="AllComplaints.html";return}M()});async function M(){const{data:{session:n}}=await l.auth.getSession();if(!n){window.location.href="Login.html";return}const{data:e,error:t}=await l.from("admin").select("id, adminrole, profile_pic").eq("id",n.user.id).single();if(t||!e){alert("Access denied."),window.location.href="Login.html";return}const i=document.getElementById("profileButton");i&&e.profile_pic&&(i.innerHTML=`
            <img src="${e.profile_pic}" alt="Profile" class="h-10 w-10 rounded-full object-cover border-2 border-white dark:border-gray-600 shadow-sm">
        `),O(C)}async function O(n){try{console.log("Loading details for complaint:",n);const{data:e,error:t}=await l.from("complaint").select("*").eq("complaintid",n).single();if(t||!e){console.error("Error fetching complaint:",t),alert("Complaint not found.");return}const{data:i}=await l.from("category").select("categoryname").eq("categoryid",e.categoryid).single(),o=i?i.categoryname:"Unknown";console.log("Category:",o);let a=null;if(e.complainantid){const{data:s,error:u}=await l.from("users").select("*").eq("id",e.complainantid).single();!u&&s?a=s:console.warn("Could not fetch user info:",u)}const{data:d,error:r}=await l.from("complaintattachment").select("*").eq("complaintid",n);r&&console.warn("Error fetching attachments:",r);let m=null,c="";if(o==="Technical"?c="technicalcomplaint":o==="Student Disciplinary"?c="studentbehaviorcomplaint":o==="Facility"?c="facilitycomplaint":o==="Administrative"?c="administrativecomplaint":o==="Academic"?c="academiccomplaint":o==="Other"&&(c="othercomplaint"),c){const{data:s,error:u}=await l.from(c).select("*").eq("complaintid",n).single();u?console.warn(`Error fetching ${c}:`,u):m=s}let I="Unassigned",w=null;if(e.adminid){const{data:s}=await l.from("admin").select("adminfirstname, adminlastname, profile_pic").eq("id",e.adminid).single();s&&(I=`${s.adminfirstname} ${s.adminlastname}`,w=s)}j(e,o,a,I,w),W(o,m),H(d),J(e)}catch(e){console.error("Unexpected error:",e),alert("An error occurred while loading details.")}}function j(n,e,t,i,o){N.textContent=n.complainttitle||"Untitled",_.textContent=`#${n.complaintid}`;const a=new Date(n.submitteddate);if(S.textContent=isNaN(a)?"N/A":a.toLocaleString(),y.textContent=n.complaintstatus,y.className=`px-3 py-1 rounded-full text-xs font-bold border inline-block ${Q(n.complaintstatus)}`,y.classList.remove("hidden"),P.textContent=n.complaintdescription||"No description provided.",t)if(L.textContent=`${t.first_name||""} ${t.last_name||""}`,B.textContent=t.role||"Student",h.textContent=t.id||"N/A",h.title=t.id||"",k.textContent=t.email||"N/A",D.textContent=t.department||"N/A",t.profile_image_url)g.src=t.profile_image_url,g.classList.remove("hidden"),f.classList.add("hidden");else{const r=t.first_name?t.first_name[0]:"",m=t.last_name?t.last_name[0]:"";f.innerText=(r+m).toUpperCase()||"U",g.classList.add("hidden"),f.classList.remove("hidden")}else L.textContent="Unknown User",B.textContent="N/A",h.textContent="N/A",k.textContent="N/A",D.textContent="N/A",f.innerText="U",g.classList.add("hidden"),f.classList.remove("hidden");if($.textContent=i,o&&o.profile_pic)b.src=o.profile_pic,b.classList.remove("hidden"),E.classList.add("hidden");else{const r=i!=="Unassigned"?i.split(" ").map(m=>m[0]).join(""):"U";E.textContent=r,b.classList.add("hidden"),E.classList.remove("hidden")}const d=document.getElementById("deleteComplaintBtn");d&&(n.complaintstatus==="Deleted"?d.classList.add("hidden"):(d.classList.remove("hidden"),d.onclick=()=>R(n)))}async function R(n){const e=prompt("Enter a reason for deleting this complaint:");if(e)try{const{error:t}=await l.from("complaint").update({complaintstatus:"Deleted",admin_feedback:e||"Deleted by Admin"}).eq("complaintid",n.complaintid);if(t)throw t;const i=`Your complaint "${n.complainttitle}" was marked as Deleted. Reason: ${e}`;if(await l.from("notifications").insert([{userid:n.complainantid,complaint_id:n.complaintid,type:"Deleted",message:i,is_read:!1}]),n.complainantEmail){const o={to_name:n.complainantName||"Student",to_email:n.complainantEmail,complaint_title:n.complainttitle,new_status:"Deleted",message:i};emailjs.send("service_q77wg09","template_sb3k70p",o,"08jWWt0PNjZJ4BcQw").then(()=>console.log("Email sent")).catch(a=>console.error("Email failed",a))}alert("Complaint deleted successfully."),window.location.href="AllComplaints.html"}catch(t){console.error("Error deleting complaint:",t),alert("Failed to delete complaint.")}}function W(n,e){if(!e)return;q.classList.remove("hidden"),T.textContent=n,x.textContent="";const t=(i,o)=>{const a=U.content.cloneNode(!0),d=a.querySelector(".field-label"),r=a.querySelector(".field-value");d.textContent=i,r.textContent=o||"N/A",o||r.classList.add("italic","text-gray-400"),x.appendChild(a)};n==="Technical"?(t("Type of Issue",e.typeofissue),t("Device Affected",e.deviceaffected),t("Previous Attempts",e.previousattempts)):n==="Student Disciplinary"?(t("Accused Name",e.accusedname),t("Type of Behavior",e.typeofbehavior),t("Location",e.locationofincident),t("Witness Details",e.witnessdetail),t("Previous Attempts",e.previousattempts)):n==="Facility"?(t("Facility Type",e.typeoffacility),t("Issue",e.typeoffacilityissue),t("Floor",e.facilityfloor),t("Previous Attempt",e.previousattempt)):n==="Administrative"?(t("Department",e.complaintdepartment),t("Staff Involved",e.staffinvolved),t("Desired Outcome",e.desiredoutcome),t("Previous Attempts",e.previousattempts)):n==="Academic"?(t("Lecturer Name",e.lecturername),t("Module Name",e.modulename),t("Batch Code",e.batchcode),t("Level",e.currentlevel),t("Semester",e.semester),t("Issue",e.specificationofissue),t("Phone",e.phone),t("Desired Outcome",e.desiredoutcome),t("Previous Attempts",e.previousattempts)):n==="Other"&&(t("Suggested Category",e.suggestedcategory),t("Desired Outcome",e.desiredoutcome),t("Previous Attempts",e.previousattempts))}function H(n){if(!n||n.length===0){p.textContent="";const e=document.createElement("p");e.className="text-gray-500 text-sm italic",e.textContent="No attachments found.",p.appendChild(e);return}p.textContent="",n.forEach(e=>{const t=F.content.cloneNode(!0),i=t.querySelector(".attachment-link"),o=t.querySelector(".attachment-filename"),a=t.querySelector(".attachment-desc");i.href=e.fileurl,o.textContent=e.filename,a.textContent=e.description||"Attachment",p.appendChild(t)})}function J(n){A.textContent="";const e=document.createElement("p");n.admin_feedback?(e.className="text-gray-700 dark:text-gray-300 whitespace-pre-wrap",e.textContent=n.admin_feedback):(e.className="text-gray-500 text-sm italic",e.textContent="No feedback provided yet."),A.appendChild(e)}function Q(n){switch(n){case"Pending":return"bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-800";case"In-Progress":return"bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800";case"Resolved":return"bg-green-100 text-green-800 border-green-200 dark:bg-green-900/30 dark:text-green-300 dark:border-green-800";case"Deleted":return"bg-red-100 text-red-800 border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-800";default:return"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"}}function Y(){const n=document.getElementById("headerLogoutBtn");n&&n.addEventListener("click",v);const e=document.getElementById("logoutModal");if(e){const i=document.getElementById("cancelLogoutBtn"),o=document.getElementById("confirmLogoutBtn");i&&i.addEventListener("click",()=>{e.classList.add("hidden")}),o&&o.addEventListener("click",async()=>{const{error:a}=await l.auth.signOut();a&&console.error("Error signing out:",a),window.location.href="Login.html"}),e.addEventListener("click",a=>{a.target===e&&e.classList.add("hidden")})}const t=setInterval(()=>{const i=document.querySelector('#mobileMenu a[href="Login.html"]');if(i)i.addEventListener("click",v),clearInterval(t);else if(document.readyState==="complete"){const o=document.querySelector('#mobileMenu a[href="Login.html"]');o&&o.addEventListener("click",v),clearInterval(t)}},100)}function v(n){n&&n.preventDefault();const e=document.getElementById("logoutModal");e&&e.classList.remove("hidden")}Y();
