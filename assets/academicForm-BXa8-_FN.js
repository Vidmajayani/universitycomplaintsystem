import{s as r}from"./supabaseClient-Du47UBJl.js";/* empty css              */document.addEventListener("DOMContentLoaded",async()=>{const y=document.getElementById("complaintForm");function o(e,t){const n=document.getElementById(e).nextElementSibling;n&&n.classList.contains("error-text")&&(n.textContent=t,n.style.color="var(--color-error, #ff4d4d)")}function c(e){return e.trim()===""?0:e.trim().split(/\s+/).length}function x(e,t,i){const n=document.getElementById(e);let l=n.value.trim();const d=c(l);document.getElementById(t).textContent=`${d} / ${i} words`,d>i&&(n.value=l.split(/\s+/).slice(0,i).join(" "))}["description","fileDesc","previousAttempt"].forEach(e=>{const t=e==="description"?"descCounter":e==="fileDesc"?"fileCounter":"attemptCounter";document.getElementById(e).addEventListener("input",()=>x(e,t,e==="description"?500:100))});let s=null;try{s=(await r.auth.getSession()).data.session}catch(e){console.error("Supabase session error:",e)}if(!s||!s.user){window.location.href="/login.html";return}const F=s.user.id;y.addEventListener("submit",async e=>{e.preventDefault(),document.querySelectorAll(".error-text").forEach(a=>a.textContent="");let t=!0;const i=document.getElementById("complaintTitle").value.trim();i||(t=!1,o("complaintTitle","Complaint title is required."));const n=document.getElementById("dateIncident").value,l=new Date(n);(!n||l>=new Date)&&(t=!1,o("dateIncident","Incident date must be before today."));const m=document.getElementById("phone").value.trim();m&&!/^[0-9]{10}$/.test(m)&&(t=!1,o("phone","Phone number must be exactly 10 digits."));const E=document.getElementById("currentLevel").value;E||(t=!1,o("currentLevel","Please select a level."));const I=document.getElementById("semester").value;I||(t=!1,o("semester","Please select a semester."));const u=document.getElementById("description").value.trim();(c(u)>500||!u)&&(t=!1,o("description","Description must be less than 500 words."));const O=document.getElementById("fileDesc").value.trim();c(O)>100&&(t=!1,o("fileDesc","File description must be less than 100 words."));const v=document.getElementById("previousAttempt").value.trim();c(v)>100&&(t=!1,o("previousAttempt","Previous attempts must be less than 100 words."));const h=document.getElementById("desiredOutcome").value.trim();if(c(h)>100&&(t=!1,o("desiredOutcome","Desired outcome must be less than 100 words.")),document.getElementById("declaration").checked||(t=!1,document.getElementById("declaration").nextElementSibling.insertAdjacentHTML("afterend",'<p class="error-text" style="color:red;">You must agree to the declaration.</p>')),!!t)try{const{data:a,error:b}=await r.from("admin").select("id").eq("adminrole","Academic Admin").single();if(b||!a){console.error("Error fetching Academic Admin:",b),alert("System Error: Could not find Academic Admin. Please contact support.");return}const $=a.id,{data:B,error:w}=await r.from("category").select("categoryid").eq("categoryname","Academic").single();if(w||!B){console.error("Error fetching Academic category:",w),alert("System Error: Could not find Academic category. Please contact support.");return}const q=B.categoryid,{data:T,error:D}=await r.from("complaint").insert([{complainantid:F,adminid:$,categoryid:q,submitteddate:new Date().toISOString(),dateofincident:n,complainttitle:i,complaintdescription:u,complaintstatus:"Pending"}]).select().single();if(D){console.error(D);return}const A=T.complaintid,{error:C}=await r.from("academiccomplaint").insert([{complaintid:A,lecturername:document.getElementById("lecturer").value.trim(),batchcode:document.getElementById("batchCode").value.trim(),modulename:document.getElementById("moduleName").value.trim(),currentlevel:E,phone:m,semester:I,specificationofissue:document.getElementById("issueSpec").value.trim(),previousattempts:v,desiredoutcome:h}]);if(C){console.error(C);return}const f=document.getElementById("file"),U=document.getElementById("fileDesc").value.trim();if(f.files.length>0)for(let p=0;p<f.files.length;p++){const g=f.files[p],j=`${Date.now()}_${g.name}`,{data:M,error:P}=await r.storage.from("user-uploads").upload(j,g);if(P){console.error("File upload error:",P),alert("File upload failed. Please try again.");return}const{data:N}=r.storage.from("user-uploads").getPublicUrl(M.path),S=N.publicUrl;console.log("File public URL:",S);const{error:L}=await r.from("complaintattachment").insert([{complaintid:A,fileurl:S,description:U,filename:g.name}]);if(L){console.error("Attachment insert error:",L),alert("Failed to save file info. Please try again.");return}}y.reset(),alert("Your Academic complaint has been submitted successfully!")}catch(a){console.error(a)}})});
