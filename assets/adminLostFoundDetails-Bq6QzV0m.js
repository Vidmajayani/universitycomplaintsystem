import{s}from"./darkMode-C5bWaft0.js";let i=null,c=null;document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await s.auth.getSession();if(!e){window.location.href="Login.html";return}const n=new URLSearchParams(window.location.search).get("id");if(!n){alert("No Item ID provided."),window.location.href="AdminLostFound.html";return}N(),await w(n),window.updateStatus=o=>I(o),window.deleteItem=()=>E(),window.openStatusModal=L,window.closeStatusModal=_,window.confirmStatusUpdate=b,window.openDeleteModal=x,window.closeDeleteModal=h,window.confirmDelete=C});async function w(e){const{data:t,error:n}=await s.from("lost_and_found").select("*").eq("item_id",e).single();if(n||!t){console.error("Error fetching item:",n),alert("Item not found.");return}i=t;const{data:o}=await s.from("users").select("*").eq("id",t.user_id).single();c=o;let a=null;const{data:{user:u}}=await s.auth.getUser();if(u){const{data:d}=await s.from("admin").select("*").eq("id",u.id).single();a=d}const{data:l}=await s.from("lost_found_attachments").select("*").eq("lost_item_id",e);v(t,o,a,l)}function L(){const e=document.getElementById("statusModal"),t=document.getElementById("modalStatusSelect"),n=document.getElementById("modalStatusReason");i&&(t.value=i.status,n.value=""),e.classList.remove("hidden")}function _(){document.getElementById("statusModal").classList.add("hidden")}async function b(){const e=document.getElementById("modalStatusSelect").value,t=document.getElementById("modalStatusReason").value.trim();if(!t&&e!=="Lost"){alert("Please enter a message for the user.");return}_(),await I(e,t)}function x(){const e=document.getElementById("deleteModal"),t=document.getElementById("modalDeleteReason");t.value="",e.classList.remove("hidden")}function h(){document.getElementById("deleteModal").classList.add("hidden")}async function C(){const e=document.getElementById("modalDeleteReason").value.trim();if(!e){alert("Please enter a reason for deletion.");return}h(),await E(e)}function v(e,t,n,o){document.getElementById("databaseId").textContent=e.item_id,document.getElementById("itemName").textContent=e.item_name,document.getElementById("itemTypeDisplay").textContent=e.item_type;const a=document.getElementById("statusBadge"),u=document.getElementById("statusHeaderBorder");a.textContent=e.status;let l,d;if(e.status==="Lost"?(l="bg-orange-100 text-orange-800",d="border-orange-400"):e.status==="Claim"?(l="bg-blue-100 text-blue-800",d="border-blue-400"):e.status==="Found"?(l="bg-green-100 text-green-800",d="border-green-400"):e.status==="Deleted"&&(l="bg-red-100 text-red-800",d="border-red-400"),a.className=`px-4 py-1.5 rounded-full text-sm font-bold ${l}`,u.className=`bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-t-8 ${d}`,document.getElementById("reportedDate").textContent=new Date(e.reported_date).toLocaleDateString(),document.getElementById("locationLost").textContent=e.location_lost||"N/A",document.getElementById("dateLost").textContent=e.date_lost?new Date(e.date_lost).toLocaleDateString():"N/A",document.getElementById("timeLost").textContent=e.time_lost||"N/A",document.getElementById("brand").textContent=e.brand||"--",document.getElementById("model").textContent=e.model||"--",document.getElementById("serialNumber").textContent=e.serial_number||"--",document.getElementById("primaryColor").textContent=e.primary_color||"--",document.getElementById("secondaryColor").textContent=e.secondary_color||"--",document.getElementById("distFeatures").textContent=e.distinguishing_features||"None reported.",document.getElementById("description").textContent=e.description||"No description provided.",document.getElementById("adminFeedbackDisplay").textContent=e.admin_feedback||"No notices sent.",t){document.getElementById("userName").textContent=`${t.first_name||""} ${t.last_name||""}`,document.getElementById("userEmail").textContent=t.email||"N/A",document.getElementById("userId").textContent=t.id||"N/A";const m=document.getElementById("userProfilePic"),r=document.getElementById("userInitials");t.profile_image_url?(m.src=t.profile_image_url,m.classList.remove("hidden"),r.classList.add("hidden")):(r.textContent=(t.first_name?.[0]||"U")+(t.last_name?.[0]||""),r.classList.remove("hidden"),m.classList.add("hidden"))}else document.getElementById("userName").textContent="Unknown User",document.getElementById("userEmail").textContent="N/A",document.getElementById("userId").textContent="N/A";const f=document.getElementById("adminName"),g=document.getElementById("adminInitials"),p=document.getElementById("adminProfilePic");if(n){const m=`${n.adminfirstname||""} ${n.adminlastname||""}`.trim();if(f.textContent=`${m} (${n.adminrole||"Admin"})`,n.profile_pic)p.src=n.profile_pic,p.classList.remove("hidden"),g.classList.add("hidden");else{const r=n.adminfirstname?n.adminfirstname[0]:"A",B=n.adminlastname?n.adminlastname[0]:"";g.textContent=(r+B).toUpperCase(),g.classList.remove("hidden"),p.classList.add("hidden")}}else f.textContent="Unassigned / Pending Review",g.textContent="?",g.classList.remove("hidden"),p.classList.add("hidden");const y=document.getElementById("imageContainer");y.innerHTML="",o&&o.length>0?o.forEach(m=>{const r=document.createElement("img");r.src=m.file_url,r.className="h-40 rounded shadow border hover:scale-105 transition cursor-pointer object-cover",r.onclick=()=>window.open(m.file_url,"_blank"),y.appendChild(r)}):y.innerHTML='<span class="text-gray-400 text-sm italic">No images attached.</span>'}async function I(e,t=""){if(!t&&e==="Claim"){if(t=prompt("Please enter a message for the user (e.g., 'A matching item was found at the Security Office. Please visit to verify.'):"),t===null)return;t||(t="A potential match has been found. Please visit the admin office.")}else if(!t&&e==="Found"){if(!confirm("Mark this item as Returned/Found? This indicates the owner has retrieved the item."))return;t="Item has been successfully returned to the owner."}else t||(t="Status updated by administrator.");try{const{error:n}=await s.from("lost_and_found").update({status:e,admin_feedback:t,admin_id:(await s.auth.getUser()).data.user.id}).eq("item_id",i.item_id);if(n)throw n;const{error:o}=await s.from("notifications").insert([{userid:i.user_id,type:e,message:`Your lost item report '${i.item_name}' status updated to ${e}. Details: ${t}`,is_read:!1,lost_item_id:i.item_id}]);if(o&&console.error("Notification failed:",o),c&&c.email){const a={to_name:c.first_name||"Student",to_email:c.email,complaint_title:`Lost Item: ${i.item_name}`,new_status:e,message:t};await emailjs.send("service_q77wg09","template_sb3k70p",a,"08jWWt0PNjZJ4BcQw")}alert(`Status updated to ${e} successfully.`),location.reload()}catch(n){console.error("Error updating status:",n),alert("Failed to update status.")}}async function E(e=""){if(!(!e&&(e=prompt("Reason for deletion?"),e===null)))try{const{error:t}=await s.from("lost_and_found").update({status:"Deleted",admin_feedback:e||"Deleted by Admin"}).eq("item_id",i.item_id);if(t)throw t;if(await s.from("notifications").insert([{userid:i.user_id,type:"Deleted",message:`Your lost item report '${i.item_name}' was deleted. Reason: ${e||"N/A"}`,is_read:!1,lost_item_id:i.item_id}]),c&&c.email){const n={to_name:c.first_name||"Student",to_email:c.email,complaint_title:`Lost Item: ${i.item_name}`,new_status:"Deleted",message:e||"N/A"};await emailjs.send("service_q77wg09","template_sb3k70p",n,"08jWWt0PNjZJ4BcQw")}alert("Item deleted."),window.location.href="AdminLostFound.html"}catch(t){console.error("Delete failed:",t),alert("Failed to delete item.")}}function N(){const e=document.getElementById("mobileMenuButton"),t=document.getElementById("mobileMenu"),n=document.getElementById("overlay");if(e&&t&&n){const d=e.cloneNode(!0);e.parentNode.replaceChild(d,e),d.addEventListener("click",()=>{t.classList.toggle("-translate-x-full"),n.classList.toggle("hidden")}),n.addEventListener("click",()=>{t.classList.add("-translate-x-full"),n.classList.add("hidden")})}const o=document.getElementById("profileButton"),a=document.getElementById("profileMenu");if(o&&a){const d=o.cloneNode(!0);o.parentNode.replaceChild(d,o),d.addEventListener("click",f=>{f.stopPropagation(),a.classList.contains("hidden")?a.classList.remove("hidden"):a.classList.add("hidden")}),document.addEventListener("click",f=>{!d.contains(f.target)&&!a.contains(f.target)&&a.classList.add("hidden")})}const u=document.getElementById("headerLogoutBtn"),l=document.getElementById("logoutModal");u&&l&&(u.addEventListener("click",()=>l.classList.remove("hidden")),document.getElementById("cancelLogoutBtn").addEventListener("click",()=>l.classList.add("hidden")),document.getElementById("confirmLogoutBtn").addEventListener("click",async()=>{await s.auth.signOut(),window.location.href="Login.html"}))}
