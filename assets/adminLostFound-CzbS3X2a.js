import{s as u}from"./darkMode-C5bWaft0.js";document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:G}}=await u.auth.getSession();if(!G){window.location.href="Login.html";return}const{data:me}=await u.from("admin").select("id, adminrole").eq("id",G.user.id).single();if(!me){window.location.href="Login.html";return}const B=document.getElementById("itemsTableBody"),A=document.getElementById("itemsCardsView"),ge=document.getElementById("itemCardTemplate"),K=document.getElementById("statusFilter"),fe=document.getElementById("itemRowTemplate"),X=document.getElementById("emptyTableStateTemplate"),ee=document.getElementById("emptyCardStateTemplate");document.getElementById("errorTableStateTemplate");let h=[],k=[],c=1;const R=10;let p="all",r={source:"all",categories:[],statuses:[],dateFrom:null,dateTo:null};ke();const P=document.getElementById("tabAllRequests"),U=document.getElementById("tabLostItems"),H=document.getElementById("tabFoundItems"),D=document.getElementById("uploadFoundItemBtn");P.addEventListener("click",()=>T("all")),U.addEventListener("click",()=>T("lost")),H.addEventListener("click",()=>T("found"));function T(e){p=e,c=1,[P,U,H].forEach(n=>n.classList.remove("active")),e==="all"&&P.classList.add("active"),e==="lost"&&U.classList.add("active"),e==="found"&&H.classList.add("active"),r.source=e,document.querySelectorAll(".filter-source-btn").forEach(n=>{n.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),n.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")});const a=document.querySelector(`.filter-source-btn[data-source="${e}"]`);a&&(a.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),a.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300")),e==="all"||e==="found"?D.classList.remove("hidden"):D.classList.add("hidden"),L()}(p==="all"||p==="found")&&D.classList.remove("hidden");const j=document.getElementById("uploadFoundModal"),te=document.getElementById("uploadFoundItemForm"),ne=document.getElementById("foundItemImage"),O=document.getElementById("imagePreview"),ye=document.getElementById("previewImg");D.addEventListener("click",()=>{j.classList.remove("hidden")}),document.getElementById("cancelUploadFoundBtn").addEventListener("click",()=>{j.classList.add("hidden"),te.reset(),O.classList.add("hidden")}),ne.addEventListener("change",e=>{const a=e.target.files[0];if(a){const n=new FileReader;n.onload=o=>{ye.src=o.target.result,O.classList.remove("hidden")},n.readAsDataURL(a)}}),document.getElementById("confirmUploadFoundBtn").addEventListener("click",async()=>{await Be()});const M=document.getElementById("filterModal"),q=document.getElementById("filterDrawer"),be=document.getElementById("openFiltersBtn"),pe=document.getElementById("closeFiltersBtn"),Le=document.getElementById("applyFiltersBtn"),Ee=document.getElementById("clearFiltersBtn"),Y=document.getElementById("filterBadge"),z=document.getElementById("searchInput"),ae=document.getElementById("prevPage"),oe=document.getElementById("nextPage"),re=document.getElementById("paginationNumbers");be.addEventListener("click",()=>{M.classList.remove("hidden"),setTimeout(()=>{q.classList.remove("scale-95","opacity-0"),q.classList.add("scale-100","opacity-100")},10)}),pe.addEventListener("click",V),M.addEventListener("click",e=>{e.target===M&&V()});function V(){q.classList.remove("scale-100","opacity-100"),q.classList.add("scale-95","opacity-0"),setTimeout(()=>{M.classList.add("hidden")},300)}document.querySelectorAll(".filter-source-btn").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.source;document.querySelectorAll(".filter-source-btn").forEach(n=>{n.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),n.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),e.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),e.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),r.source=a})}),document.querySelector('.filter-source-btn[data-source="all"]').click(),document.querySelectorAll(".filter-category-chip").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.category,n=r.categories.indexOf(a);n>-1?(r.categories.splice(n,1),e.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")):(r.categories.push(a),e.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),e.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"))}),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),document.querySelectorAll(".filter-status-chip").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.status,n=r.statuses.indexOf(a);n>-1?(r.statuses.splice(n,1),e.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")):(r.statuses.push(a),e.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),e.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"))}),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),document.querySelectorAll(".date-preset-btn").forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.preset,n=new Date;let o,d;switch(a){case"today":o=d=n;break;case"last7days":d=n,o=new Date(n),o.setDate(n.getDate()-7);break;case"last30days":d=n,o=new Date(n),o.setDate(n.getDate()-30);break;case"thismonth":o=new Date(n.getFullYear(),n.getMonth(),1),d=n;break}const s=l=>{const g=l.getFullYear(),t=String(l.getMonth()+1).padStart(2,"0"),i=String(l.getDate()).padStart(2,"0");return`${g}-${t}-${i}`};document.getElementById("filterModalDateFrom").value=s(o),document.getElementById("filterModalDateTo").value=s(d),document.querySelectorAll(".date-preset-btn").forEach(l=>{l.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),l.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),e.classList.remove("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300"),e.classList.add("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300")})}),Le.addEventListener("click",()=>{r.dateFrom=document.getElementById("filterModalDateFrom").value,r.dateTo=document.getElementById("filterModalDateTo").value,de(),T(r.source),V()}),Ee.addEventListener("click",()=>{r={source:"all",categories:[],statuses:[],dateFrom:null,dateTo:null},document.querySelectorAll(".filter-category-chip, .filter-status-chip, .date-preset-btn").forEach(e=>{e.classList.remove("border-blue-600","bg-blue-50","text-blue-600","dark:bg-blue-900/30","dark:text-blue-300"),e.classList.add("border-gray-300","dark:border-gray-600","text-gray-700","dark:text-gray-300")}),document.querySelector('.filter-source-btn[data-source="all"]').click(),document.getElementById("filterModalDateFrom").value="",document.getElementById("filterModalDateTo").value="",de(),c=1,L()});function de(){let e=0;r.source!=="all"&&e++,e+=r.categories.length,e+=r.statuses.length,(r.dateFrom||r.dateTo)&&e++,e>0?(Y.textContent=e,Y.classList.remove("hidden")):Y.classList.add("hidden")}z.addEventListener("input",()=>{c=1,L()}),ae.addEventListener("click",()=>{c>1&&(c--,L())}),oe.addEventListener("click",()=>{c++,L()});const W=new URLSearchParams(window.location.search).get("status");W&&Array.from(K.options).some(a=>a.value===W)&&(K.value=W),await J(),await N();async function J(){const{data:e,error:a}=await u.from("lost_and_found").select("*").neq("status","Deleted").order("reported_date",{ascending:!1});if(a){console.error(a),B.innerHTML="";const n=document.getElementById("errorTableStateTemplate");n?B.appendChild(n.content.cloneNode(!0)):B.innerHTML='<tr><td colspan="7" class="text-center py-6 text-red-500">Error loading items</td></tr>';return}h=e,k.length>0&&L()}async function N(){const{data:e,error:a}=await u.from("found_items").select("*").order("created_at",{ascending:!1});if(a){console.error("Error loading found items:",a);return}k=e||[],L()}function Ie(e=null){const a=document.getElementById("totalItemsCount"),n=a.parentElement.childNodes[0];let o=0;const d=r.categories.length>0||r.statuses.length>0||r.dateFrom||r.dateTo||z.value.trim()!=="";e!==null?(o=e,d?n.textContent="Results Found: ":n.textContent="Total Items: "):(p==="all"?o=h.length+k.length:p==="lost"?o=h.length:p==="found"&&(o=k.length),n.textContent="Total Items: "),a.innerText=o}function L(){B.innerHTML="",A.innerHTML="";const e=z.value.toLowerCase();let a=[];p==="all"?a=[...h.map(t=>({...t,itemSource:"lost"})),...k.map(t=>({...t,itemSource:"found"}))]:p==="lost"?a=h.map(t=>({...t,itemSource:"lost"})):p==="found"&&(a=k.map(t=>({...t,itemSource:"found"})));let n=a.filter(t=>{const i=r.categories.length===0||r.categories.includes(t.item_type),S=r.statuses.length===0||r.statuses.includes(t.status);let b=!0;if(r.dateFrom||r.dateTo){const E=new Date(t.itemSource==="lost"?t.reported_date:t.created_at);if(E.setHours(0,0,0,0),r.dateFrom){const m=new Date(r.dateFrom);m.setHours(0,0,0,0),E<m&&(b=!1)}if(r.dateTo&&b){const m=new Date(r.dateTo);m.setHours(0,0,0,0),E>m&&(b=!1)}}const F=t.itemSource==="lost"?t.location_lost||"":t.location_found||"",C=(t.item_name||"").toLowerCase().includes(e)||(t.item_type||"").toLowerCase().includes(e)||(t.description||"").toLowerCase().includes(e)||(t.distinguishing_features||"").toLowerCase().includes(e)||(t.brand||"").toLowerCase().includes(e)||(t.model||"").toLowerCase().includes(e)||(t.serial_number||"").toLowerCase().includes(e)||(t.primary_color||"").toLowerCase().includes(e)||(t.secondary_color||"").toLowerCase().includes(e)||F.toLowerCase().includes(e);return i&&S&&b&&C});const o=n.length,d=Math.ceil(o/R);Ie(o),c>d&&(c=d||1),c<1&&(c=1);const s=(c-1)*R,l=Math.min(s+R,o),g=n.slice(s,l);if(document.getElementById("startRange").textContent=o===0?0:s+1,document.getElementById("endRange").textContent=l,document.getElementById("totalEntries").textContent=o,he(d),n.length===0){xe();return}g.forEach(t=>{const i=t.itemSource==="found";t.date_lost&&new Date(t.date_lost).toLocaleDateString();const S=i?t.created_at?new Date(t.created_at).toLocaleDateString():"N/A":t.reported_date?new Date(t.reported_date).toLocaleDateString():"N/A",b=i?t.location_found||"Unknown":t.location_lost||"Unknown",F=t.brand?`Brand: ${t.brand}`:"",C=t.primary_color?`Color: ${t.primary_color}`:"",E=[F,C].filter(Boolean).join(", ")||"-";let m="bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-300",w=t.status||"N/A";i?(m="hidden",w=""):(t.status==="Lost"&&(m="bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300"),t.status==="Claim"&&(m="bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300"),t.status==="Found"&&(m="bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"),t.status==="Deleted"&&(m="bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300"));const x=i?t.found_item_id:t.item_id,f=fe.content.cloneNode(!0);f.querySelector(".item-name").textContent=t.item_name;const $=f.querySelector(".item-source");i?($.textContent="Found Item",$.className="item-source px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300"):($.textContent="Lost Item",$.className="item-source px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300"),f.querySelector(".item-type").textContent=t.item_type,f.querySelector(".item-location").textContent=b,f.querySelector(".item-date").textContent=S,f.querySelector(".item-attributes").textContent=E;const ce=f.querySelector(".item-status");ce.textContent=w,ce.className=`item-status px-3 py-1 rounded-full text-xs font-bold ${m}`,i?(f.querySelector(".btn-edit").style.display="none",f.querySelector(".btn-delete").style.display="none"):(f.querySelector(".btn-edit").onclick=()=>window.openStatusModal(x,t.status,t.itemSource),f.querySelector(".btn-delete").onclick=()=>window.openDeleteModal(x,t.itemSource)),f.querySelector(".btn-preview").href=i?`AdminFoundItemDetails.html?id=${x}`:`AdminLostFoundDetails.html?id=${x}`,B.appendChild(f);const y=ge.content.cloneNode(!0);y.querySelector(".card-type").textContent=t.item_type,y.querySelector(".card-title").textContent=t.item_name,y.querySelector(".card-location span").textContent=b,y.querySelector(".card-date").textContent=S;const ue=y.querySelector(".card-status");ue.textContent=w,ue.className=`card-status px-2 py-0.5 rounded text-[10px] font-bold uppercase ${m}`,y.querySelector(".card-attr").textContent=E,i?(y.querySelector(".btn-edit").style.display="none",y.querySelector(".btn-delete").style.display="none"):(y.querySelector(".btn-edit").onclick=()=>window.openStatusModal(x,t.status,t.itemSource),y.querySelector(".btn-delete").onclick=()=>window.openDeleteModal(x,t.itemSource)),y.querySelector(".Link-preview").href=i?`AdminFoundItemDetails.html?id=${x}`:`AdminLostFoundDetails.html?id=${x}`,A.appendChild(y)})}function xe(){if(X){const e=X.content.cloneNode(!0);B.appendChild(e)}if(ee){const e=ee.content.cloneNode(!0);A.appendChild(e)}}function he(e){re.innerHTML="",ae.disabled=c===1,oe.disabled=c===e||e===0;let a=[];e<=7?a=Array.from({length:e},(n,o)=>o+1):c<=4?a=[1,2,3,4,5,"...",e]:c>=e-3?a=[1,"...",e-4,e-3,e-2,e-1,e]:a=[1,"...",c-1,c,c+1,"...",e],a.forEach(n=>{const o=document.createElement("button");o.className=`px-3 py-1 border rounded ${n===c?"bg-blue-600 text-white border-blue-600":"hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-white"}`,n==="..."?(o.textContent="...",o.disabled=!0,o.classList.add("cursor-default","border-none")):(o.textContent=n,o.onclick=()=>{c=n,L()}),re.appendChild(o)})}const Q=document.getElementById("statusModal"),Z=document.getElementById("deleteModal"),_=document.getElementById("modalStatusSelect"),se=document.getElementById("modalStatusReason"),le=document.getElementById("modalDeleteReason");let I=null,v=null;window.openStatusModal=(e,a,n)=>{I=e,v=n,_.innerHTML="",n==="found"?_.innerHTML=`
                <option value="Unclaimed">Unclaimed</option>
                <option value="Claimed">Claimed</option>
            `:_.innerHTML=`
                <option value="Lost">Lost</option>
                <option value="Claim">Claim (Match)</option>
                <option value="Found">Found (Returned)</option>
            `,_.value=a,se.value="",Q.classList.remove("hidden")},window.openDeleteModal=(e,a)=>{I=e,v=a,le.value="",Z.classList.remove("hidden")},document.getElementById("cancelStatusBtn").addEventListener("click",()=>Q.classList.add("hidden")),document.getElementById("cancelDeleteBtn").addEventListener("click",()=>Z.classList.add("hidden")),document.getElementById("confirmStatusBtn").addEventListener("click",async()=>{const e=_.value,a=se.value.trim();if(!a){alert("Please provide a feedback message/reason.");return}try{const n=v==="found"?"found_items":"lost_and_found",o=v==="found"?"found_item_id":"item_id",{error:d}=await u.from(n).update({status:e,admin_feedback:a}).eq(o,I);if(d)throw d;const s=h.find(l=>l.item_id===I);s&&s.user_id&&(await u.from("notifications").insert([{userid:s.user_id,type:"LostItemUpdate",message:`Status updated to ${e}. ${a}`,is_read:!1,lost_item_id:I}]),ie(s,e,a)),Q.classList.add("hidden"),await J(),await N(),alert(`Status updated to ${e}`)}catch(n){console.error(n),alert("Failed to update status")}}),document.getElementById("confirmDeleteBtn").addEventListener("click",async()=>{const e=le.value.trim();if(!e){alert("Please provide a reason for deletion.");return}try{const a=v==="found"?"found_items":"lost_and_found",n=v==="found"?"found_item_id":"item_id",{error:o}=await u.from(a).update({status:"Deleted",admin_feedback:e}).eq(n,I);if(o)throw o;const d=h.find(s=>s.item_id===I);d&&d.user_id&&(await u.from("notifications").insert([{userid:d.user_id,type:"Deleted",message:`Your report was deleted. Reason: ${e}`,is_read:!1,lost_item_id:I}]),ie(d,"Deleted",e)),Z.classList.add("hidden"),await J(),await N(),alert("Item marked as deleted.")}catch(a){console.error(a),alert("Failed to delete item")}});async function ie(e,a,n){try{const{data:o,error:d}=await u.from("users").select("email, first_name").eq("id",e.user_id).single();if(d||!o||!o.email)return;const s={to_name:o.first_name||"Student",to_email:o.email,complaint_title:`Lost Item: ${e.item_name}`,new_status:a,message:n};await emailjs.send("service_q77wg09","template_sb3k70p",s,"08jWWt0PNjZJ4BcQw"),console.log("Email sent successfully")}catch(o){console.error("Failed to send email:",o)}}async function Be(){const e=ne.files[0];if(!e){alert("Please upload an image. Image is required for found items.");return}const a=document.getElementById("foundItemName").value.trim(),n=document.getElementById("foundItemType").value,o=document.getElementById("foundLocationFound").value.trim(),d=document.getElementById("foundDateFound").value;if(!a||!n||!o||!d){alert("Please fill in all required fields (Item Name, Type, Location Found, Date Found).");return}if(e.size>5*1024*1024){alert("Image size must be less than 5MB.");return}let s=null;try{const{data:{session:l}}=await u.auth.getSession();if(!l){alert("Session expired. Please login again.");return}const g=e.name.split(".").pop(),i=`found_items/${`${Date.now()}_${Math.random().toString(36).substring(7)}.${g}`}`,{data:S,error:b}=await u.storage.from("lost_found_images").upload(i,e);if(b)throw new Error(`Image upload failed: ${b.message}`);const{data:{publicUrl:F}}=u.storage.from("lost_found_images").getPublicUrl(i),C={admin_id:l.user.id,item_name:a,item_type:n,brand:document.getElementById("foundBrand").value.trim()||null,model:document.getElementById("foundModel").value.trim()||null,primary_color:document.getElementById("foundPrimaryColor").value.trim()||null,secondary_color:document.getElementById("foundSecondaryColor").value.trim()||null,serial_number:document.getElementById("foundSerialNumber").value.trim()||null,distinguishing_features:document.getElementById("foundDistinguishingFeatures").value.trim()||null,description:document.getElementById("foundDescription").value.trim()||null,location_found:o,date_found:d,time_found:document.getElementById("foundTimeFound").value||null,status:"Unclaimed"},{data:E,error:m}=await u.from("found_items").insert([C]).select().single();if(m)throw await u.storage.from("lost_found_images").remove([i]),new Error(`Database insert failed: ${m.message}`);s=E.found_item_id;const{error:w}=await u.from("lost_found_attachments").insert([{found_item_id:E.found_item_id,file_url:F,file_type:"image"}]);if(w)throw await u.from("found_items").delete().eq("found_item_id",s),await u.storage.from("lost_found_images").remove([i]),new Error(`Attachment insert failed: ${w.message}`);alert("Found item uploaded successfully!"),j.classList.add("hidden"),te.reset(),O.classList.add("hidden"),await N(),L()}catch(l){console.error("Error uploading found item:",l),alert(`Failed to upload found item: ${l.message}`)}}function ke(){const e=document.getElementById("mobileMenuButton"),a=document.getElementById("mobileMenu"),n=document.getElementById("overlay");if(e&&a){const g=e.cloneNode(!0);e.parentNode.replaceChild(g,e),g.addEventListener("click",()=>{a.classList.toggle("-translate-x-full"),n&&n.classList.toggle("hidden")}),n&&n.addEventListener("click",()=>{a.classList.add("-translate-x-full"),n.classList.add("hidden")})}const o=document.getElementById("profileButton"),d=document.getElementById("profileMenu");if(o&&d){const g=o.cloneNode(!0);o.parentNode.replaceChild(g,o),g.addEventListener("click",t=>{t.stopPropagation(),d.classList.contains("hidden")?d.classList.remove("hidden"):d.classList.add("hidden")}),document.addEventListener("click",t=>{!g.contains(t.target)&&!d.contains(t.target)&&d.classList.add("hidden")})}const s=document.getElementById("headerLogoutBtn"),l=document.getElementById("logoutModal");if(s&&l){const g=s.cloneNode(!0);s.parentNode.replaceChild(g,s),g.addEventListener("click",()=>l.classList.remove("hidden"));const t=document.getElementById("cancelLogoutBtn"),i=document.getElementById("confirmLogoutBtn");t&&(t.onclick=()=>l.classList.add("hidden")),i&&(i.onclick=async()=>{await u.auth.signOut(),window.location.href="Login.html"})}}});
