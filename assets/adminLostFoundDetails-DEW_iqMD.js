import{s}from"./darkMode-DwWyDh1G.js";let r=null,c=null;document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await s.auth.getSession();if(!e){window.location.href="Login.html";return}const n=new URLSearchParams(window.location.search).get("id");if(!n){alert("No Item ID provided."),window.location.href="AdminLostFound.html";return}D(),await w(n),window.updateStatus=o=>p(o),window.deleteItem=()=>E(),window.openStatusModal=L,window.closeStatusModal=h,window.confirmStatusUpdate=C,window.openDeleteModal=x,window.closeDeleteModal=y,window.confirmDelete=v});async function w(e){const{data:t,error:n}=await s.from("lost_and_found").select("*").eq("item_id",e).single();if(n||!t){console.error("Error fetching item:",n),alert("Item not found.");return}r=t;const{data:o}=await s.from("users").select("*").eq("id",t.user_id).single();c=o;let d=null;const{data:{user:l}}=await s.auth.getUser();if(l){const{data:a}=await s.from("admin").select("*").eq("id",l.id).single();d=a}const{data:i}=await s.from("lost_found_attachments").select("*").eq("lost_item_id",e);b(t,o,d,i)}function L(){const e=document.getElementById("statusModal"),t=document.getElementById("modalStatusSelect"),n=document.getElementById("modalStatusReason");r&&(t.value=r.status,n.value="");const o=document.getElementById("foundItemIdContainer"),d=document.getElementById("modalFoundItemId"),l=document.getElementById("foundItemIdError"),i=t.cloneNode(!0);t.parentNode.replaceChild(i,t),i.addEventListener("change",function(){this.value==="Found"?o.classList.remove("hidden"):(o.classList.add("hidden"),d.value="",l.classList.add("hidden"))}),i.dispatchEvent(new Event("change")),e.classList.remove("hidden")}function h(){document.getElementById("statusModal").classList.add("hidden")}async function C(){const e=document.getElementById("modalStatusSelect").value,t=document.getElementById("modalStatusReason").value.trim(),n=document.getElementById("modalFoundItemId").value.trim(),o=document.getElementById("foundItemIdError");if(o.classList.add("hidden"),o.textContent="",!t&&e!=="Lost"){alert("Please enter a message for the user.");return}if(e==="Found"){if(!n){o.textContent="Found Item ID is required when marking as Found.",o.classList.remove("hidden");return}try{const{data:d,error:l}=await s.from("found_items").select("found_item_id, status, item_name").eq("found_item_id",n).single();if(l||!d){o.textContent="Found Item ID does not exist in the system.",o.classList.remove("hidden");return}if(d.status!=="Unclaimed"){o.textContent=`This Found Item is already ${d.status}. Please use an Unclaimed item.`,o.classList.remove("hidden");return}}catch(d){console.error("Validation error:",d),o.textContent="Error validating Found Item ID. Please try again.",o.classList.remove("hidden");return}}if(e==="Claim"&&n){o.textContent="Cannot link Found Item ID when status is Claim. Only use Found Item ID for Found status.",o.classList.remove("hidden");return}h(),await p(e,t,n)}function x(){const e=document.getElementById("deleteModal"),t=document.getElementById("modalDeleteReason");t.value="",e.classList.remove("hidden")}function y(){document.getElementById("deleteModal").classList.add("hidden")}async function v(){const e=document.getElementById("modalDeleteReason").value.trim();if(!e){alert("Please enter a reason for deletion.");return}y(),await E(e)}function b(e,t,n,o){document.getElementById("databaseId").textContent=e.item_id,document.getElementById("itemName").textContent=e.item_name,document.getElementById("itemTypeDisplay").textContent=e.item_type;const d=document.getElementById("statusBadge"),l=document.getElementById("statusHeaderBorder");d.textContent=e.status;let i,a;if(e.status==="Lost"?(i="bg-orange-100 text-orange-800",a="border-orange-400"):e.status==="Claim"?(i="bg-blue-100 text-blue-800",a="border-blue-400"):e.status==="Found"?(i="bg-green-100 text-green-800",a="border-green-400"):e.status==="Deleted"&&(i="bg-red-100 text-red-800",a="border-red-400"),d.className=`px-4 py-1.5 rounded-full text-sm font-bold ${i}`,l.className=`bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-t-8 ${a}`,document.getElementById("reportedDate").textContent=new Date(e.reported_date).toLocaleDateString(),document.getElementById("locationLost").textContent=e.location_lost||"N/A",document.getElementById("dateLost").textContent=e.date_lost?new Date(e.date_lost).toLocaleDateString():"N/A",document.getElementById("timeLost").textContent=e.time_lost||"N/A",document.getElementById("brand").textContent=e.brand||"--",document.getElementById("model").textContent=e.model||"--",document.getElementById("serialNumber").textContent=e.serial_number||"--",document.getElementById("primaryColor").textContent=e.primary_color||"--",document.getElementById("secondaryColor").textContent=e.secondary_color||"--",document.getElementById("distFeatures").textContent=e.distinguishing_features||"None reported.",document.getElementById("description").textContent=e.description||"No description provided.",document.getElementById("adminFeedbackDisplay").textContent=e.admin_feedback||"No notices sent.",t){document.getElementById("userName").textContent=`${t.first_name||""} ${t.last_name||""}`,document.getElementById("userEmail").textContent=t.email||"N/A",document.getElementById("userId").textContent=t.id||"N/A";const u=document.getElementById("userProfilePic"),m=document.getElementById("userInitials");t.profile_image_url?(u.src=t.profile_image_url,u.classList.remove("hidden"),m.classList.add("hidden")):(m.textContent=(t.first_name?.[0]||"U")+(t.last_name?.[0]||""),m.classList.remove("hidden"),u.classList.add("hidden"))}else document.getElementById("userName").textContent="Unknown User",document.getElementById("userEmail").textContent="N/A",document.getElementById("userId").textContent="N/A";const f=document.getElementById("adminName"),g=document.getElementById("adminInitials"),_=document.getElementById("adminProfilePic");if(n){const u=`${n.adminfirstname||""} ${n.adminlastname||""}`.trim();if(f.textContent=`${u} (${n.adminrole||"Admin"})`,n.profile_pic)_.src=n.profile_pic,_.classList.remove("hidden"),g.classList.add("hidden");else{const m=n.adminfirstname?n.adminfirstname[0]:"A",B=n.adminlastname?n.adminlastname[0]:"";g.textContent=(m+B).toUpperCase(),g.classList.remove("hidden"),_.classList.add("hidden")}}else f.textContent="Unassigned / Pending Review",g.textContent="?",g.classList.remove("hidden"),_.classList.add("hidden");const I=document.getElementById("imageContainer");I.innerHTML="",o&&o.length>0?o.forEach(u=>{const m=document.createElement("img");m.src=u.file_url,m.className="h-40 rounded shadow border hover:scale-105 transition cursor-pointer object-cover",m.onclick=()=>window.open(u.file_url,"_blank"),I.appendChild(m)}):I.innerHTML='<span class="text-gray-400 text-sm italic">No images attached.</span>',e.status==="Found"&&e.matched_found_item_id&&N(e.matched_found_item_id)}async function N(e){try{const{data:t,error:n}=await s.from("found_items").select("found_item_id, item_name, item_type, location_found, date_found").eq("found_item_id",e).single();if(n||!t){console.error("Error loading matched found item:",n);return}document.getElementById("matchedFoundItemCard").classList.remove("hidden"),document.getElementById("matchedFoundId").textContent=t.found_item_id,document.getElementById("matchedFoundItemName").textContent=t.item_name||"N/A",document.getElementById("matchedFoundItemType").textContent=t.item_type||"N/A",document.getElementById("matchedFoundLocation").textContent=t.location_found||"N/A"}catch(t){console.error("Error fetching matched found item:",t)}}async function p(e,t="",n=""){if(!t&&e==="Claim"){if(t=prompt("Please enter a message for the user (e.g., 'A matching item was found at the Security Office. Please visit to verify.'):"),t===null)return;t||(t="A potential match has been found. Please visit the admin office.")}else if(!t&&e==="Found"){if(!confirm("Mark this item as Returned/Found? This indicates the owner has retrieved the item."))return;t="Item has been successfully returned to the owner."}else t||(t="Status updated by administrator.");try{const o=(await s.auth.getUser()).data.user.id,d={status:e,admin_feedback:t,admin_id:o};e==="Found"&&n&&(d.matched_found_item_id=n);const{error:l}=await s.from("lost_and_found").update(d).eq("item_id",r.item_id);if(l)throw l;if(e==="Found"&&n){const{error:a}=await s.from("found_items").update({status:"Claimed",matched_lost_item_id:r.item_id}).eq("found_item_id",n);a&&(console.error("Error updating found item:",a),alert("Lost item updated, but failed to update found item status. Please check manually."))}const{error:i}=await s.from("notifications").insert([{userid:r.user_id,type:e,message:`Your lost item report '${r.item_name}' status updated to ${e}. Details: ${t}`,is_read:!1,lost_item_id:r.item_id}]);if(i&&console.error("Notification failed:",i),c&&c.email){const a={to_name:c.first_name||"Student",to_email:c.email,complaint_title:`Lost Item: ${r.item_name}`,new_status:e,message:t};await emailjs.send("service_q77wg09","template_sb3k70p",a,"08jWWt0PNjZJ4BcQw")}alert(`Status updated to ${e} successfully.`),location.reload()}catch(o){console.error("Error updating status:",o),alert("Failed to update status.")}}async function E(e=""){if(!(!e&&(e=prompt("Reason for deletion?"),e===null)))try{const{error:t}=await s.from("lost_and_found").update({status:"Deleted",admin_feedback:e||"Deleted by Admin"}).eq("item_id",r.item_id);if(t)throw t;if(await s.from("notifications").insert([{userid:r.user_id,type:"Deleted",message:`Your lost item report '${r.item_name}' was deleted. Reason: ${e||"N/A"}`,is_read:!1,lost_item_id:r.item_id}]),c&&c.email){const n={to_name:c.first_name||"Student",to_email:c.email,complaint_title:`Lost Item: ${r.item_name}`,new_status:"Deleted",message:e||"N/A"};await emailjs.send("service_q77wg09","template_sb3k70p",n,"08jWWt0PNjZJ4BcQw")}alert("Item deleted."),window.location.href="AdminLostFound.html"}catch(t){console.error("Delete failed:",t),alert("Failed to delete item.")}}function D(){const e=document.getElementById("mobileMenuButton"),t=document.getElementById("mobileMenu"),n=document.getElementById("overlay");if(e&&t&&n){const a=e.cloneNode(!0);e.parentNode.replaceChild(a,e),a.addEventListener("click",()=>{t.classList.toggle("-translate-x-full"),n.classList.toggle("hidden")}),n.addEventListener("click",()=>{t.classList.add("-translate-x-full"),n.classList.add("hidden")})}const o=document.getElementById("profileButton"),d=document.getElementById("profileMenu");if(o&&d){const a=o.cloneNode(!0);o.parentNode.replaceChild(a,o),a.addEventListener("click",f=>{f.stopPropagation(),d.classList.contains("hidden")?d.classList.remove("hidden"):d.classList.add("hidden")}),document.addEventListener("click",f=>{!a.contains(f.target)&&!d.contains(f.target)&&d.classList.add("hidden")})}const l=document.getElementById("headerLogoutBtn"),i=document.getElementById("logoutModal");l&&i&&(l.addEventListener("click",()=>i.classList.remove("hidden")),document.getElementById("cancelLogoutBtn").addEventListener("click",()=>i.classList.add("hidden")),document.getElementById("confirmLogoutBtn").addEventListener("click",async()=>{await s.auth.signOut(),window.location.href="Login.html"}))}
