import{s as i}from"./supabaseClient-Du47UBJl.js";/* empty css              */document.addEventListener("DOMContentLoaded",async()=>{const g=document.getElementById("adminComplaintForm"),o=document.getElementById("description"),c=document.getElementById("previousAttempts"),d=document.getElementById("fileDesc"),m=document.getElementById("staffInvolved"),S=document.getElementById("declaration"),y=document.getElementById("adminType"),h=document.getElementById("descCounter"),E=document.getElementById("attemptCounter"),I=document.getElementById("fileCounter");function a(t){return t.trim().split(/\s+/).filter(Boolean).length}function u(t,e,n){t.addEventListener("input",()=>{let r=a(t.value);if(r>n){const l=t.value.split(/\s+/).slice(0,n).join(" ");t.value=l,r=n}e.textContent=`${r} / ${n} words`})}u(o,h,500),u(c,E,100),u(d,I,100);let s=null;try{s=(await i.auth.getSession()).data.session}catch(t){console.error("Supabase session error:",t)}if(!s||!s.user){window.location.href="/login.html";return}const F=s.user.id;g.addEventListener("submit",async t=>{t.preventDefault();let e=[];const n=document.getElementById("complaintTitle").value.trim();if(n?/^[A-Za-z0-9\s]+$/.test(n)||e.push("Complaint title can only contain letters, numbers, and spaces."):e.push("Complaint title is required."),y.value||e.push("Please select a Type of Administration."),o.value.trim()||e.push("Description is required."),S.checked||e.push("You must declare that the information provided is accurate."),m.value.trim()&&!/^[a-zA-Z0-9\s]+$/.test(m.value)&&e.push("Staff Involved can only contain letters, numbers, and spaces."),a(o.value)>500&&e.push("Description cannot exceed 500 words."),a(c.value)>100&&e.push("Previous attempts cannot exceed 100 words."),a(d.value)>100&&e.push("File description cannot exceed 100 words."),e.length>0){alert(e.join(`
`));return}try{const{data:r,error:l}=await i.from("admin").select("id").eq("adminrole","Administrative Admin").single();if(l||!r){console.error("Error fetching Administrative Admin:",l),alert("System Error: Could not find Administrative Admin. Please contact support.");return}const $=r.id,{data:w,error:C}=await i.from("category").select("categoryid").eq("categoryname","Administrative").single();if(C||!w){console.error("Error fetching Administrative category:",C),alert("System Error: Could not find Administrative category. Please contact support.");return}const T=w.categoryid,{data:q,error:A}=await i.from("complaint").insert([{complainantid:F,adminid:$,categoryid:T,submitteddate:new Date().toISOString(),dateofincident:new Date().toISOString(),complainttitle:n,complaintdescription:o.value.trim(),complaintstatus:"Pending"}]).select().single();if(A){console.error("Complaint insert error:",A),alert("Failed to submit complaint. Please try again.");return}const D=q.complaintid,{error:B}=await i.from("administrativecomplaint").insert([{complaintid:D,complaintdepartment:y.value,staffinvolved:m.value.trim()||null,previousattempts:c.value.trim()||null,desiredoutcome:document.getElementById("desiredOutcome").value.trim()||null}]);if(B){console.error("Administrative complaint insert error:",B),alert("Failed to save administrative complaint. Please try again.");return}const p=document.getElementById("file"),L=d.value.trim();if(p.files.length>0)for(let f=0;f<p.files.length;f++){const v=p.files[f],O=`${Date.now()}_${v.name}`,{data:U,error:b}=await i.storage.from("user-uploads").upload(O,v);if(b){console.error("File upload error:",b),alert("File upload failed. Please try again.");return}const{data:j}=i.storage.from("user-uploads").getPublicUrl(U.path),z=j.publicUrl,{error:P}=await i.from("complaintattachment").insert([{complaintid:D,fileurl:z,description:L,filename:v.name}]);if(P){console.error("Attachment insert error:",P),alert("Failed to save file info. Please try again.");return}}g.reset(),h.textContent="0 / 500 words",E.textContent="0 / 100 words",I.textContent="0 / 100 words",alert("Administrative complaint submitted successfully!")}catch(r){console.error(r),alert("Something went wrong. Please try again.")}})});
