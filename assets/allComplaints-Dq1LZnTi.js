import{s as f}from"./supabaseClient-DP-aSKaS.js";import"./darkMode-CrEeUdWV.js";let v=null,S=null,m=[],h=[],P={},u=1;const k=5,w=document.getElementById("complaintsTableBody"),O=document.getElementById("searchInput"),L=document.getElementById("filterStatus"),E=document.getElementById("filterCategory"),H=document.getElementById("totalComplaintsCount"),te=document.getElementById("startRange"),ne=document.getElementById("endRange"),ae=document.getElementById("totalEntries"),J=document.getElementById("prevPage"),Y=document.getElementById("nextPage"),I=document.getElementById("paginationNumbers"),oe=document.getElementById("complaintRowTemplate");document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:e}}=await f.auth.getSession();if(!e){window.location.href="Login.html";return}re(),xe()});async function re(){const{data:{session:e}}=await f.auth.getSession();if(!e){window.location.href="Login.html";return}const{data:t,error:n}=await f.from("admin").select("id, adminrole, profile_pic").eq("id",e.user.id).single();if(n||!t){alert("Access denied."),window.location.href="Login.html";return}v=t.id,S=t.adminrole;const a=document.getElementById("profileButton");a&&t.profile_pic&&(a.innerHTML=`
            <img src="${t.profile_pic}" alt="Profile" class="h-10 w-10 rounded-full object-cover border-2 border-white dark:border-gray-600 shadow-sm">
        `),console.log(`Logged in as Admin: ${S} (${v})`),S==="Master Admin"&&E&&E.classList.remove("hidden"),await le();const r=new URLSearchParams(window.location.search).get("status");r&&L&&(L.value=r),ie()}async function ie(){try{w.textContent="";const e=document.createElement("tr"),t=document.createElement("td");t.colSpan=7,t.className="py-6 text-center",t.textContent="Loading complaints...",e.appendChild(t),w.appendChild(e);let n=f.from("complaint").select("*");S!=="Master Admin"&&(n=n.eq("adminid",v)),n=n.neq("complaintstatus","Deleted");const{data:a,error:i}=await n.order("submitteddate",{ascending:!1});if(i)throw i;if(m=a||[],m=m.map(r=>({...r,categoryName:P[r.categoryid]||"Unknown Category"})),m.length>0){const r=[...new Set(m.map(l=>l.complainantid))],{data:c,error:o}=await f.from("users").select("id, first_name, last_name, email").in("id",r);if(!o&&c){const l={};c.forEach(d=>{l[d.id]={name:`${d.first_name} ${d.last_name}`,email:d.email}}),m=m.map(d=>{const p=l[d.complainantid];return{...d,complainantName:p?p.name:"Unknown User",complainantEmail:p?p.email:null}})}}ee(),x()}catch(e){console.error("Error loading complaints:",e),w.textContent="";const t=document.createElement("tr"),n=document.createElement("td");n.colSpan=7,n.className="py-6 text-center text-red-500",n.textContent="Error loading complaints. Please try again.",t.appendChild(n),w.appendChild(t)}}async function le(){try{const{data:e,error:t}=await f.from("category").select("categoryid, categoryname");if(t)throw t;e&&(e.forEach(n=>{P[n.categoryid]=n.categoryname}),console.log("Categories loaded:",P))}catch(e){console.error("Error fetching categories:",e)}}function D(){const e=document.getElementById("complaintsTableBody"),t=document.getElementById("complaintsCardsView");if(e&&(e.textContent=""),t&&(t.textContent=""),h.length===0){if(e){const o=document.createElement("tr"),l=document.createElement("td");l.colSpan=7,l.className="py-8 text-center text-gray-500 dark:text-gray-400",l.innerHTML='<i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i><br>No complaints found.',o.appendChild(l),e.appendChild(o)}t&&(t.innerHTML=`
                <div class="col-span-full py-8 text-center text-gray-500 dark:text-gray-400">
                    <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i><br>No complaints found.
                </div>
            `);return}const n=(u-1)*k,a=Math.min(n+k,h.length),i=h.slice(n,a);te.textContent=h.length>0?n+1:0,ne.textContent=a,ae.textContent=h.length;const r=document.createDocumentFragment(),c=document.createDocumentFragment();i.forEach(o=>{const l=oe.content.cloneNode(!0);l.querySelector("tr"),l.querySelector(".col-title").textContent=o.complainttitle||"Untitled";const d=l.querySelector(".col-category"),p=o.categoryName||"General";d.textContent=p;const y=s=>s==="Academic"?"bg-purple-100 text-purple-600 dark:bg-purple-900 dark:text-purple-300":s==="Facility"?"bg-orange-100 text-orange-600 dark:bg-orange-900 dark:text-orange-300":s==="Technical"?"bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300":s==="Administrative"?"bg-pink-100 text-pink-600 dark:bg-pink-900 dark:text-pink-300":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300";d.className=`col-category inline-block px-3 py-1 rounded-full text-xs font-semibold ${y(p)}`;const _=l.querySelector(".col-desc");_.textContent=o.complaintdescription||"-",_.title=o.complaintdescription||"";const $=new Date(o.submitteddate).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"});l.querySelector(".col-date").textContent=$;const R=o.complainantName||"Unknown User";l.querySelector(".complainant-name").textContent=R,l.querySelector(".complainant-id").textContent=o.complainantid||"";const T=l.querySelector(".col-status");T.textContent=o.complaintstatus;const F=s=>s==="Pending"?"bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300":s==="In-Progress"?"bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300":s==="Resolved"?"bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300":s==="Deleted"?"bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-400":"bg-gray-100 text-gray-600";T.className=`col-status py-1 px-3 rounded-full text-xs font-semibold ${F(o.complaintstatus)}`;const A=s=>{const q=s.querySelector(".btn-preview"),g=s.querySelector(".btn-status"),b=s.querySelector(".btn-delete");q&&(q.onclick=()=>window.location.href=`AdminComplaintDetails.html?id=${o.complaintid}`),g&&(g.onclick=()=>fe(o.complaintid,o.complaintstatus)),b&&(b.onclick=()=>deleteComplaint(o.complaintid))};if(A(l),r.appendChild(l),t){const s=document.getElementById("complaintCardTemplate");if(s){const g=s.content.cloneNode(!0).querySelector("div");g.querySelector(".card-category").textContent=p,g.querySelector(".card-category").className=`card-category px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${y(p)}`,g.querySelector(".card-title").textContent=o.complainttitle||"Untitled",g.querySelector(".card-user").textContent=R,g.querySelector(".card-id").textContent=o.complainantid||"N/A",g.querySelector(".card-date").textContent=$;const b=g.querySelector(".card-status");b.textContent=o.complaintstatus,b.className=`card-status px-2 py-0.5 rounded text-[10px] font-bold uppercase ${F(o.complaintstatus)}`;const U=g.querySelector(".card-desc");U.textContent=o.complaintdescription||"No description provided.",U.title=o.complaintdescription||"",A(g),c.appendChild(g)}}}),e&&e.appendChild(r),t&&t.appendChild(c)}const G=document.getElementById("statusModal"),Q=document.getElementById("deleteModal"),Z=document.getElementById("modalStatusSelect"),z=document.getElementById("modalStatusReason"),K=document.getElementById("modalDeleteReason"),ce=document.getElementById("confirmStatusBtn"),se=document.getElementById("cancelStatusBtn"),de=document.getElementById("confirmDeleteBtn"),me=document.getElementById("cancelDeleteBtn");let C=null;function ue(e,t){C=e,Z.value=t,z.value="",G.classList.remove("hidden")}function j(){G.classList.add("hidden"),C=null}function pe(e){C=e,K.value="",Q.classList.remove("hidden")}function V(){Q.classList.add("hidden"),C=null}ge();function ge(){se.addEventListener("click",j),ce.addEventListener("click",async()=>{const e=Z.value,t=z.value.trim();if(!t){alert("Please provide a reason for the status change.");return}await ye(C,e,t),j()}),me.addEventListener("click",V),de.addEventListener("click",async()=>{const e=K.value.trim();if(!e){alert("Please provide a reason for deletion.");return}await he(C,e),V()})}async function fe(e,t,n){ue(e,t)}async function ye(e,t,n){try{const a={complaintstatus:t,admin_feedback:n};t==="Resolved"&&(a.resolveddate=new Date().toISOString(),a.resolvedby=v);const{error:i}=await f.from("complaint").update(a).eq("complaintid",e);if(i)throw i;const r=m.find(c=>c.complaintid===e);if(r&&r.complainantid){const c=`Your complaint "${r.complainttitle||"Complaint"}" status has been updated to ${t}. Reason: ${n}`;await f.from("notifications").insert([{userid:r.complainantid,complaint_id:e,type:t,message:c,is_read:!1}]),await X(r.complainantEmail,r.complainantName,r.complainttitle,t,n)}m=m.map(c=>c.complaintid===e?{...c,...a}:c),x(),alert(`Status updated to ${t} and user notified!`)}catch(a){console.error("Error updating status:",a),alert("Failed to update status.")}}async function X(e,t,n,a,i){if(!e){console.warn("No email found for user. Skipping email notification.");return}const r={to_name:t,to_email:e,complaint_title:n,new_status:a,message:i};try{await emailjs.send("service_q77wg09","template_sb3k70p",r,"08jWWt0PNjZJ4BcQw"),console.log(`Email sent to ${e}`)}catch(c){console.error("EmailJS Error:",c)}}window.deleteComplaint=e=>{pe(e)};async function he(e,t){try{const{error:n}=await f.from("complaint").update({complaintstatus:"Deleted",admin_feedback:t}).eq("complaintid",e);if(n)throw n;const a=m.find(i=>i.complaintid===e);if(a&&a.complainantid){const i=`Your complaint "${a.complainttitle||"Complaint"}" was marked as Deleted. Reason: ${t}`;await f.from("notifications").insert([{userid:a.complainantid,complaint_id:e,type:"Deleted",message:i,is_read:!1}]),await X(a.complainantEmail,a.complainantName,a.complainttitle,"Deleted",t)}m=m.map(i=>i.complaintid===e?{...i,complaintstatus:"Deleted",admin_feedback:t}:i),x(),ee(),alert("Complaint deleted and user notified.")}catch(n){console.error("Error deleting complaint:",n),alert("Failed to delete complaint.")}}function x(){const e=O.value.toLowerCase(),t=L.value;h=m.filter(n=>{const a=n.complainttitle&&n.complainttitle.toLowerCase().includes(e)||n.complaintdescription&&n.complaintdescription.toLowerCase().includes(e)||n.complaintid&&n.complaintid.toString().includes(e)||n.complainantName&&n.complainantName.toLowerCase().includes(e),i=t===""||n.complaintstatus===t,r=E?E.value:"",c=r===""||n.categoryName===r,o=document.getElementById("filterDateFrom").value,l=document.getElementById("filterDateTo").value;let d=!0;if(o||l){const p=new Date(n.submitteddate);if(p.setHours(0,0,0,0),o){const y=new Date(o);y.setHours(0,0,0,0),p<y&&(d=!1)}if(l&&d){const y=new Date(l);y.setHours(0,0,0,0),p>y&&(d=!1)}}return a&&i&&c&&d}),u=1,D(),N()}function N(){I.textContent="";const e=Math.ceil(h.length/k);if(J.disabled=u===1,Y.disabled=u===e||e===0,window.innerWidth<1280){const n=document.createElement("span");n.className="px-4 py-1 text-sm font-medium text-gray-600 dark:text-gray-300",n.textContent=`Page ${u} of ${e}`,I.appendChild(n);return}if(e<=5+2)for(let n=1;n<=e;n++)B(n);else{B(1),u>3&&W();const n=Math.max(2,u-1),a=Math.min(e-1,u+1);for(let i=n;i<=a;i++)B(i);u<e-2&&W(),B(e)}}function B(e){const t=document.createElement("button");t.textContent=e,t.className=`px-3 py-1 border rounded transition ${u===e?"bg-eco text-white border-eco":"hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-white"}`,t.addEventListener("click",()=>{u=e,D(),N()}),I.appendChild(t)}function W(){const e=document.createElement("span");e.textContent="...",e.className="px-2 py-1 text-gray-500 dark:text-gray-400",I.appendChild(e)}function xe(){O.addEventListener("input",x),L.addEventListener("change",x),E&&E.addEventListener("change",x);const e=document.getElementById("filterDateFrom"),t=document.getElementById("filterDateTo");e&&e.addEventListener("change",x),t&&t.addEventListener("change",x),J.addEventListener("click",()=>{u>1&&(u--,D(),N())}),Y.addEventListener("click",()=>{const r=Math.ceil(h.length/k);u<r&&(u++,D(),N())});const n=document.getElementById("headerLogoutBtn");n&&n.addEventListener("click",M);const a=document.getElementById("logoutModal");if(a){const r=document.getElementById("cancelLogoutBtn"),c=document.getElementById("confirmLogoutBtn");r&&r.addEventListener("click",()=>{a.classList.add("hidden")}),c&&c.addEventListener("click",async()=>{const{error:o}=await f.auth.signOut();o&&console.error("Error signing out:",o),window.location.href="Login.html"}),a.addEventListener("click",o=>{o.target===a&&a.classList.add("hidden")})}const i=setInterval(()=>{const r=document.querySelector('#mobileMenu a[href="Login.html"]');if(r)r.addEventListener("click",M),clearInterval(i);else if(document.readyState==="complete"){const c=document.querySelector('#mobileMenu a[href="Login.html"]');c&&c.addEventListener("click",M),clearInterval(i)}},100)}function M(e){e&&e.preventDefault();const t=document.getElementById("logoutModal");t&&t.classList.remove("hidden")}function ee(){H&&(H.textContent=m.length)}
