import{s as n}from"./darkMode-0kXEi02e.js";const _=5*1024*1024;document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:a}}=await n.auth.getSession();if(!a||!a.user){window.location.href="Login.html";return}const u=document.getElementById("technicalForm"),m=document.getElementById("issueType"),p=document.getElementById("device"),c=document.getElementById("dateIncident"),l=document.getElementById("description"),f=document.getElementById("fileDesc"),g=document.getElementById("previousAttempts"),A=document.getElementById("declaration"),h=document.getElementById("complaintTitle"),y=document.getElementById("descCounter"),v=document.getElementById("fileCounter"),I=document.getElementById("attemptCounter"),E=new Date().toISOString().split("T")[0];c.max=E;function s(i,t,o){i.addEventListener("input",()=>{let e=i.value.trim().split(/\s+/).filter(Boolean);e.length>o&&(i.value=e.slice(0,o).join(" "),e=e.slice(0,o)),t.textContent=`${e.length} / ${o} words`})}s(l,y,500),s(f,v,100),s(g,I,100);let d=a;if(!d||!d.user){window.location.href="Login.html";return}const F=d.user.id;u.addEventListener("submit",async i=>{i.preventDefault();let t=[];h.value.trim()||t.push("Complaint title is required."),m.value||t.push("Type of Issue is required."),p.value.trim()||t.push("Device / Software Affected is required."),l.value.trim()||t.push("Description of Issue is required."),A.checked||t.push("You must accept the declaration."),c.value>E&&t.push("Date of Issue cannot be in the future.");let e=document.getElementById("file").files[0];if(e&&e.size>_&&t.push("File must be smaller than 5MB."),t.length>0){alert(t.join(`
`));return}try{const{data:r,error:w}=await n.from("admin").select("id").eq("adminrole","Technical Admin").single();if(w||!r){console.error("Error fetching Technical Admin:",w),alert("System Error: Could not find Technical Admin. Please contact support.");return}const L=r.id,{data:C,error:D}=await n.from("category").select("categoryid").eq("categoryname","Technical").single();if(D||!C){console.error("Error fetching Technical category:",D),alert("System Error: Could not find Technical category. Please contact support.");return}const q=C.categoryid,{data:P,error:B}=await n.from("complaint").insert([{complainantid:F,adminid:L,categoryid:q,submitteddate:new Date().toISOString(),dateofincident:c.value,complainttitle:h.value.trim(),complaintdescription:l.value.trim(),complaintstatus:"Pending"}]).select().single();if(B){console.error("Complaint insert failed:",B),alert("Failed to save complaint.");return}const T=P.complaintid,{error:S}=await n.from("technicalcomplaint").insert([{complaintid:T,typeofissue:m.value,deviceaffected:p.value.trim(),previousattempts:g.value.trim()}]);if(S){console.error("Technical insert failed:",S),alert("Failed to save technical complaint.");return}if(e){const $=`${Date.now()}_${e.name}`,{data:M,error:b}=await n.storage.from("user-uploads").upload($,e);if(b){console.error("File upload error:",b),alert("File upload failed.");return}const{data:O}=n.storage.from("user-uploads").getPublicUrl(M.path),U=O.publicUrl;await n.from("complaintattachment").insert([{complaintid:T,fileurl:U,filename:e.name,description:f.value.trim()}])}u.reset(),y.textContent="0 / 500 words",v.textContent="0 / 100 words",I.textContent="0 / 100 words",alert("Technical complaint submitted successfully!")}catch(r){console.error(r),alert("Something went wrong. Please try again.")}})});
