import{s as p}from"./supabaseClient-Du47UBJl.js";/* empty css              */import"./darkMode-DMjetaZp.js";let k=null,S=null,d=[],y=[],D={},m=1;const B=5,w=document.getElementById("complaintsTableBody"),O=document.getElementById("searchInput"),v=document.getElementById("filterStatus"),h=document.getElementById("filterCategory"),U=document.getElementById("totalComplaintsCount"),tt=document.getElementById("startRange"),et=document.getElementById("endRange"),nt=document.getElementById("totalEntries"),W=document.getElementById("prevPage"),J=document.getElementById("nextPage"),L=document.getElementById("paginationNumbers"),at=document.getElementById("complaintRowTemplate");document.addEventListener("DOMContentLoaded",async()=>{const{data:{session:t}}=await p.auth.getSession();if(!t){window.location.href="Login.html";return}ot(),xt()});async function ot(){const{data:{session:t}}=await p.auth.getSession();if(!t){window.location.href="Login.html";return}const{data:e,error:n}=await p.from("admin").select("id, adminrole, profile_pic").eq("id",t.user.id).single();if(n||!e){alert("Access denied."),window.location.href="Login.html";return}k=e.id,S=e.adminrole;const a=document.getElementById("profileButton");a&&e.profile_pic&&(a.innerHTML=`
            <img src="${e.profile_pic}" alt="Profile" class="h-10 w-10 rounded-full object-cover border-2 border-white dark:border-gray-600 shadow-sm">
        `),console.log(`Logged in as Admin: ${S} (${k})`),S==="Master Admin"&&h&&h.classList.remove("hidden"),await it();const i=new URLSearchParams(window.location.search).get("status");i&&v&&(v.value=i),rt()}async function rt(){try{w.textContent="";const t=document.createElement("tr"),e=document.createElement("td");e.colSpan=7,e.className="py-6 text-center",e.textContent="Loading complaints...",t.appendChild(e),w.appendChild(t);let n=p.from("complaint").select("*");S!=="Master Admin"&&(n=n.eq("adminid",k));const{data:a,error:o}=await n.order("submitteddate",{ascending:!1});if(o)throw o;if(d=a||[],d=d.map(i=>({...i,categoryName:D[i.categoryid]||"Unknown Category"})),d.length>0){const i=[...new Set(d.map(l=>l.complainantid))],{data:c,error:r}=await p.from("users").select("id, first_name, last_name, email").in("id",i);if(!r&&c){const l={};c.forEach(g=>{l[g.id]={name:`${g.first_name} ${g.last_name}`,email:g.email}}),d=d.map(g=>{const f=l[g.complainantid];return{...g,complainantName:f?f.name:"Unknown User",complainantEmail:f?f.email:null}})}}X(),x()}catch(t){console.error("Error loading complaints:",t),w.textContent="";const e=document.createElement("tr"),n=document.createElement("td");n.colSpan=7,n.className="py-6 text-center text-red-500",n.textContent="Error loading complaints. Please try again.",e.appendChild(n),w.appendChild(e)}}async function it(){try{const{data:t,error:e}=await p.from("category").select("categoryid, categoryname");if(e)throw e;t&&(t.forEach(n=>{D[n.categoryid]=n.categoryname}),console.log("Categories loaded:",D))}catch(t){console.error("Error fetching categories:",t)}}function I(){const t=document.getElementById("complaintsTableBody"),e=document.getElementById("complaintsCardsView");if(t&&(t.textContent=""),e&&(e.textContent=""),y.length===0){if(t){const r=document.createElement("tr"),l=document.createElement("td");l.colSpan=7,l.className="py-8 text-center text-gray-500 dark:text-gray-400",l.innerHTML='<i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i><br>No complaints found.',r.appendChild(l),t.appendChild(r)}e&&(e.innerHTML=`
                <div class="col-span-full py-8 text-center text-gray-500 dark:text-gray-400">
                    <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i><br>No complaints found.
                </div>
            `);return}const n=(m-1)*B,a=Math.min(n+B,y.length),o=y.slice(n,a);tt.textContent=y.length>0?n+1:0,et.textContent=a,nt.textContent=y.length;const i=document.createDocumentFragment(),c=document.createDocumentFragment();o.forEach(r=>{const l=at.content.cloneNode(!0);l.querySelector("tr"),l.querySelector(".col-title").textContent=r.complainttitle||"Untitled";const g=l.querySelector(".col-category"),f=r.categoryName||"General";g.textContent=f;const P=s=>s==="Academic"?"bg-purple-100 text-purple-600 dark:bg-purple-900 dark:text-purple-300":s==="Facility"?"bg-orange-100 text-orange-600 dark:bg-orange-900 dark:text-orange-300":s==="Technical"?"bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-300":s==="Administrative"?"bg-pink-100 text-pink-600 dark:bg-pink-900 dark:text-pink-300":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300";g.className=`col-category inline-block px-3 py-1 rounded-full text-xs font-semibold ${P(f)}`;const M=l.querySelector(".col-desc");M.textContent=r.complaintdescription||"-",M.title=r.complaintdescription||"";const _=new Date(r.submitteddate).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"});l.querySelector(".col-date").textContent=_;const $=r.complainantName||"Unknown User";l.querySelector(".complainant-name").textContent=$,l.querySelector(".complainant-id").textContent=r.complainantid||"";const R=l.querySelector(".col-status");R.textContent=r.complaintstatus;const T=s=>s==="Pending"?"bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-300":s==="In-Progress"?"bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300":s==="Resolved"?"bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-300":s==="Deleted"?"bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-400":"bg-gray-100 text-gray-600";R.className=`col-status py-1 px-3 rounded-full text-xs font-semibold ${T(r.complaintstatus)}`;const A=s=>{const q=s.querySelector(".btn-preview"),u=s.querySelector(".btn-status"),b=s.querySelector(".btn-delete");q&&(q.onclick=()=>window.location.href=`AdminComplaintDetails.html?id=${r.complaintid}`),u&&(u.onclick=()=>gt(r.complaintid,r.complaintstatus)),b&&(b.onclick=()=>deleteComplaint(r.complaintid))};if(A(l),i.appendChild(l),e){const s=document.getElementById("complaintCardTemplate");if(s){const u=s.content.cloneNode(!0).querySelector("div");u.querySelector(".card-category").textContent=f,u.querySelector(".card-category").className=`card-category px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${P(f)}`,u.querySelector(".card-title").textContent=r.complainttitle||"Untitled",u.querySelector(".card-user").textContent=$,u.querySelector(".card-id").textContent=r.complainantid||"N/A",u.querySelector(".card-date").textContent=_;const b=u.querySelector(".card-status");b.textContent=r.complaintstatus,b.className=`card-status px-2 py-0.5 rounded text-[10px] font-bold uppercase ${T(r.complaintstatus)}`;const F=u.querySelector(".card-desc");F.textContent=r.complaintdescription||"No description provided.",F.title=r.complaintdescription||"",A(u),c.appendChild(u)}}}),t&&t.appendChild(i),e&&e.appendChild(c)}const Y=document.getElementById("statusModal"),G=document.getElementById("deleteModal"),Q=document.getElementById("modalStatusSelect"),Z=document.getElementById("modalStatusReason"),z=document.getElementById("modalDeleteReason"),lt=document.getElementById("confirmStatusBtn"),ct=document.getElementById("cancelStatusBtn"),st=document.getElementById("confirmDeleteBtn"),dt=document.getElementById("cancelDeleteBtn");let C=null;function mt(t,e){C=t,Q.value=e,Z.value="",Y.classList.remove("hidden")}function j(){Y.classList.add("hidden"),C=null}function ut(t){C=t,z.value="",G.classList.remove("hidden")}function V(){G.classList.add("hidden"),C=null}pt();function pt(){ct.addEventListener("click",j),lt.addEventListener("click",async()=>{const t=Q.value,e=Z.value.trim();if(!e){alert("Please provide a reason for the status change.");return}await ft(C,t,e),j()}),dt.addEventListener("click",V),st.addEventListener("click",async()=>{const t=z.value.trim();if(!t){alert("Please provide a reason for deletion.");return}await yt(C,t),V()})}async function gt(t,e,n){mt(t,e)}async function ft(t,e,n){try{const a={complaintstatus:e,admin_feedback:n};e==="Resolved"&&(a.resolveddate=new Date().toISOString(),a.resolvedby=k);const{error:o}=await p.from("complaint").update(a).eq("complaintid",t);if(o)throw o;const i=d.find(c=>c.complaintid===t);if(i&&i.complainantid){const c=`Your complaint "${i.complainttitle||"Complaint"}" status has been updated to ${e}. Reason: ${n}`;await p.from("notifications").insert([{userid:i.complainantid,complaint_id:t,type:e,message:c,is_read:!1}]),await K(i.complainantEmail,i.complainantName,i.complainttitle,e,n)}d=d.map(c=>c.complaintid===t?{...c,...a}:c),x(),alert(`Status updated to ${e} and user notified!`)}catch(a){console.error("Error updating status:",a),alert("Failed to update status.")}}async function K(t,e,n,a,o){if(!t){console.warn("No email found for user. Skipping email notification.");return}const i={to_name:e,to_email:t,complaint_title:n,new_status:a,message:o};try{await emailjs.send("service_q77wg09","template_sb3k70p",i,"08jWWt0PNjZJ4BcQw"),console.log(`Email sent to ${t}`)}catch(c){console.error("EmailJS Error:",c)}}window.deleteComplaint=t=>{ut(t)};async function yt(t,e){try{const{error:n}=await p.from("complaint").update({complaintstatus:"Deleted",admin_feedback:e}).eq("complaintid",t);if(n)throw n;const a=d.find(o=>o.complaintid===t);if(a&&a.complainantid){const o=`Your complaint "${a.complainttitle||"Complaint"}" was marked as Deleted. Reason: ${e}`;await p.from("notifications").insert([{userid:a.complainantid,complaint_id:t,type:"Deleted",message:o,is_read:!1}]),await K(a.complainantEmail,a.complainantName,a.complainttitle,"Deleted",e)}d=d.map(o=>o.complaintid===t?{...o,complaintstatus:"Deleted",admin_feedback:e}:o),x(),X(),alert("Complaint deleted and user notified.")}catch(n){console.error("Error deleting complaint:",n),alert("Failed to delete complaint.")}}function x(){const t=O.value.toLowerCase(),e=v.value;y=d.filter(n=>{const a=n.complainttitle&&n.complainttitle.toLowerCase().includes(t)||n.complaintdescription&&n.complaintdescription.toLowerCase().includes(t)||n.complaintid&&n.complaintid.toString().includes(t)||n.complainantName&&n.complainantName.toLowerCase().includes(t),o=e===""||n.complaintstatus===e,i=h?h.value:"",c=i===""||n.categoryName===i;return a&&o&&c}),m=1,I(),N()}function N(){L.textContent="";const t=Math.ceil(y.length/B);if(W.disabled=m===1,J.disabled=m===t||t===0,window.innerWidth<1280){const n=document.createElement("span");n.className="px-4 py-1 text-sm font-medium text-gray-600 dark:text-gray-300",n.textContent=`Page ${m} of ${t}`,L.appendChild(n);return}if(t<=5+2)for(let n=1;n<=t;n++)E(n);else{E(1),m>3&&H();const n=Math.max(2,m-1),a=Math.min(t-1,m+1);for(let o=n;o<=a;o++)E(o);m<t-2&&H(),E(t)}}function E(t){const e=document.createElement("button");e.textContent=t,e.className=`px-3 py-1 border rounded transition ${m===t?"bg-eco text-white border-eco":"hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600 dark:text-white"}`,e.addEventListener("click",()=>{m=t,I(),N()}),L.appendChild(e)}function H(){const t=document.createElement("span");t.textContent="...",t.className="px-2 py-1 text-gray-500 dark:text-gray-400",L.appendChild(t)}function xt(){O.addEventListener("input",x),v.addEventListener("change",x),h&&h.addEventListener("change",x),W.addEventListener("click",()=>{m>1&&(m--,I(),N())}),J.addEventListener("click",()=>{const e=Math.ceil(y.length/B);m<e&&(m++,I(),N())});const t=document.getElementById("headerLogoutBtn");t&&t.addEventListener("click",ht)}async function ht(){const{error:t}=await p.auth.signOut();t?(console.error("Error signing out:",t),alert("Failed to log out.")):window.location.href="Login.html"}function X(){U&&(U.textContent=d.length)}
